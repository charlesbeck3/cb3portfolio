{% extends "portfolio/base.html" %}
{% load portfolio_extras %}
{% load humanize %}

{% block title %}Dashboard - Portfol{% endblock %}

{% block content %}
{% with account_count=account_types|length %}
{% widthratio account_count 1 3 as account_value_columns %}
<style>
    .dashboard-content .holdings-table {
        table-layout: fixed;
        font-size: 0.8rem;
    }

    .dashboard-content .holdings-table col.col-asset {
        width: var(--asset-col-width, 18%);
    }

    .dashboard-content .holdings-table col.col-account {
        width: calc(
            (100% - var(--asset-col-width, 18%) - var(--total-col-width, 21%))
            / var(--account-columns, 12)
        );
    }

    .dashboard-content .holdings-table col.col-total-sub {
        width: calc(var(--total-col-width, 21%) / 3);
        white-space: nowrap;
    }
</style>

<div class="dashboard-content" style="--account-columns: {{ account_value_columns }};">
<div class="row">
    <!-- Sidebar Column -->
    <div class="col-md-2 d-none d-md-block px-0">
        {% include "portfolio/sidebar.html" %}
    </div>

    <!-- Main Content Column -->
    <div class="col-md-10">
        <div class="row">
            <div class="col-md-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h1 class="mb-0">Dashboard</h1>
                        <p class="lead mb-0 text-muted">Welcome to your portfolio manager.</p>
                    </div>
                    <div>
                        <a href="{% url 'portfolio:holdings' %}" class="btn btn-primary">View Holdings</a>
                        <a href="#" class="btn btn-secondary">Rebalance</a>
                    </div>
                </div>

                <div class="card mt-4">
                    <div class="card-header">
                        Holdings Summary
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-bordered holdings-table">
                                <colgroup>
                                    <col class="col-asset">
                                    {% for code, label in account_types %}
                                    <col class="col-account">
                                    <col class="col-account">
                                    <col class="col-account">
                                    {% endfor %}
                                    <col class="col-total-sub">
                                    <col class="col-total-sub">
                                    <col class="col-total-sub">
                                </colgroup>
                                <thead>
                                    <tr>
                                        <th rowspan="2">Asset Class</th>
                                        {% for code, label in account_types %}
                                        <th colspan="3" class="text-center">{{ label }}</th>
                                        {% endfor %}
                                        <th colspan="3" class="text-center text-nowrap">Total</th>
                                    </tr>
                                    <tr>
                                        {% for code, label in account_types %}
                                        <th class="text-end">Current</th>
                                        <th class="text-end">Target</th>
                                        <th class="text-end">vTarget</th>
                                        {% endfor %}
                                        <th class="text-end">Current</th>
                                        <th class="text-end">Target</th>
                                        <th class="text-end">vTarget</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for group_code, group_data in summary.groups.items %}
                                    {% for category_code, category_data in group_data.categories.items %}
                                    {% for asset_class_name, asset_class_data in category_data.asset_classes.items %}
                                    <tr class="group-{{ forloop.parentloop.parentloop.counter }}-rows collapse show">
                                        <td class="ps-4">{{ asset_class_name }}</td>
                                        {% for code, label in account_types %}
                                        {% with data=asset_class_data.account_types|get_item:code %}
                                        <td class="text-end">{{ data.current|accounting_amount:0 }}</td>
                                        <td class="text-end">{{ data.target|accounting_amount:0 }}</td>
                                        <td class="text-end {% if data.variance >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            {{ data.variance|accounting_amount:0 }}
                                        </td>
                                        {% endwith %}
                                        {% endfor %}
                                        <td class="text-end fw-bold text-nowrap">{{ asset_class_data.total|accounting_amount:0 }}</td>
                                        <td class="text-end fw-bold text-nowrap">{{ asset_class_data.target_total|accounting_amount:0 }}</td>
                                        <td class="text-end fw-bold text-nowrap {% if asset_class_data.variance_total >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            {{ asset_class_data.variance_total|accounting_amount:0 }}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                    {% if group_data.categories|length > 1 and category_data.asset_classes|length > 1 %}
                                    <tr
                                        class="table-secondary fw-bold group-{{ forloop.parentloop.counter }}-rows collapse show">
                                        {% with category_label=summary.category_labels|get_item:category_code %}
                                        <td class="ps-4">{{ category_label|default:category_code }} Total</td>
                                        {% endwith %}
                                        {% for code, label in account_types %}
                                        {% with current=category_data.account_type_totals|get_item:code target=category_data.account_type_target_totals|get_item:code variance=category_data.account_type_variance_totals|get_item:code %}
                                        <td class="text-end">{{ current|accounting_amount:0 }}</td>
                                        <td class="text-end">{{ target|accounting_amount:0 }}</td>
                                        <td class="text-end {% if variance >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            {{ variance|accounting_amount:0 }}
                                        </td>
                                        {% endwith %}
                                        {% endfor %}
                                        <td class="text-end text-nowrap">{{ category_data.total|accounting_amount:0 }}</td>
                                        <td class="text-end text-nowrap">{{ category_data.target_total|accounting_amount:0 }}</td>
                                        <td class="text-end text-nowrap {% if category_data.variance_total >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            {{ category_data.variance_total|accounting_amount:0 }}
                                        </td>
                                    </tr>
                                    {% endif %}
                                    {% endfor %}
                                    {% if group_data.asset_class_count > 1 %}
                                    <tr class="table-primary fw-bold border-top group-toggle mt-3"
                                        data-bs-toggle="collapse" data-bs-target=".group-{{ forloop.counter }}-rows"
                                        aria-expanded="true" role="button">
                                        <td>{{ group_data.label|default:group_code }} Total</td>
                                        {% for code, label in account_types %}
                                        {% with current=group_data.account_type_totals|get_item:code target=group_data.account_type_target_totals|get_item:code variance=group_data.account_type_variance_totals|get_item:code %}
                                        <td class="text-end">{{ current|accounting_amount:0 }}</td>
                                        <td class="text-end">{{ target|accounting_amount:0 }}</td>
                                        <td class="text-end {% if variance >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            {{ variance|accounting_amount:0 }}
                                        </td>
                                        {% endwith %}
                                        {% endfor %}
                                        <td class="text-end text-nowrap">{{ group_data.total|accounting_amount:0 }}</td>
                                        <td class="text-end text-nowrap">{{ group_data.target_total|accounting_amount:0 }}</td>
                                        <td class="text-end text-nowrap {% if group_data.variance_total >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            {{ group_data.variance_total|accounting_amount:0 }}
                                        </td>
                                    </tr>
                                    {% endif %}
                                    {% endfor %}
                                </tbody>
                                <tfoot>
                                    <tr class="table-dark fw-bold">
                                        <td>Grand Total</td>
                                        {% for code, label in account_types %}
                                        {% with current=summary.account_type_grand_totals|get_item:code target=summary.account_type_grand_target_totals|get_item:code variance=summary.account_type_grand_variance_totals|get_item:code %}
                                        <td class="text-end">{{ current|accounting_amount:0 }}</td>
                                        <td class="text-end">{{ target|accounting_amount:0 }}</td>
                                        <td class="text-end {% if variance >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            {{ variance|accounting_amount:0 }}
                                        </td>
                                        {% endwith %}
                                        {% endfor %}
                                        <td class="text-end text-nowrap">
                                            {{ summary.grand_total|accounting_amount:0 }}
                                        </td>
                                        <td class="text-end text-nowrap">
                                            {{ summary.grand_target_total|accounting_amount:0 }}
                                        </td>
                                        <td class="text-end text-nowrap {% if summary.grand_variance_total >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            {{ summary.grand_variance_total|accounting_amount:0 }}
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="card mt-3">
                    <div class="card-header">
                        Allocation by Account Type (Percentage)
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-bordered mb-0 holdings-table">
                                <colgroup>
                                    <col class="col-asset">
                                    {% for code, label in account_types %}
                                    <col class="col-account">
                                    <col class="col-account">
                                    <col class="col-account">
                                    {% endfor %}
                                    <col class="col-total-sub">
                                    <col class="col-total-sub">
                                    <col class="col-total-sub">
                                </colgroup>
                                <thead>
                                    <tr>
                                        <th rowspan="2">Asset Class</th>
                                        {% for code, label in account_types %}
                                        <th colspan="3" class="text-center">{{ label }}</th>
                                        {% endfor %}
                                        <th colspan="3" class="text-center text-nowrap">Total</th>
                                    </tr>
                                    <tr>
                                        {% for code, label in account_types %}
                                        <th class="text-end">Current</th>
                                        <th class="text-end">Target</th>
                                        <th class="text-end">vTarget</th>
                                        {% endfor %}
                                        <th class="text-end">Current</th>
                                        <th class="text-end">Target</th>
                                        <th class="text-end">vTarget</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for group_code, group_data in summary.groups.items %}
                                    {% for category_code, category_data in group_data.categories.items %}
                                    {% for asset_class_name, asset_class_data in category_data.asset_classes.items %}
                                    <tr>
                                        <td class="ps-4">{{ asset_class_name }}</td>
                                        {% for code, label in account_types %}
                                        {% with data=asset_class_data.account_types|get_item:code column_total=summary.account_type_grand_totals|get_item:code %}
                                        {% with current_pct=data.current|percentage_of:column_total target_pct=data.target|percentage_of:column_total %}
                                        <td class="text-end">{{ current_pct|accounting_percent:1 }}</td>
                                        <td class="text-end">{{ target_pct|accounting_percent:1 }}</td>
                                        {% with variance_pct=current_pct|subtract:target_pct %}
                                        <td class="text-end {% if variance_pct >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            {{ variance_pct|accounting_percent:1 }}
                                        </td>
                                        {% endwith %}
                                        {% endwith %}
                                        {% endwith %}
                                        {% endfor %}
                                        {% with current_pct=asset_class_data.total|percentage_of:summary.grand_total target_pct=asset_class_data.target_total|percentage_of:summary.grand_target_total %}
                                        <td class="text-end fw-bold text-nowrap">{{ current_pct|accounting_percent:1 }}</td>
                                        <td class="text-end fw-bold text-nowrap">{{ target_pct|accounting_percent:1 }}</td>
                                        <td class="text-end fw-bold text-nowrap {% if asset_class_data.variance_total >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            {{ current_pct|subtract:target_pct|accounting_percent:1 }}
                                        </td>
                                        {% endwith %}
                                    </tr>
                                    {% endfor %}
                                    {% if group_data.categories|length > 1 and category_data.asset_classes|length > 1 %}
                                    <tr class="table-secondary fw-bold">
                                        {% with category_label=summary.category_labels|get_item:category_code %}
                                        <td class="ps-4">{{ category_label|default:category_code }} Total</td>
                                        {% endwith %}
                                        {% for code, label in account_types %}
                                        {% with current=category_data.account_type_totals|get_item:code target=category_data.account_type_target_totals|get_item:code variance=category_data.account_type_variance_totals|get_item:code %}
                                        {% with current_total=summary.account_type_grand_totals|get_item:code target_total=summary.account_type_grand_target_totals|get_item:code %}
                                        {% with current_pct=current|percentage_of:current_total target_pct=target|percentage_of:target_total %}
                                        <td class="text-end">{{ current_pct|accounting_percent:1 }}</td>
                                        <td class="text-end">{{ target_pct|accounting_percent:1 }}</td>
                                        {% with variance_pct=current_pct|subtract:target_pct %}
                                        <td class="text-end {% if variance_pct >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            {{ variance_pct|accounting_percent:1 }}
                                        </td>
                                        {% endwith %}
                                        {% endwith %}
                                        {% endwith %}
                                        {% endwith %}
                                        {% endfor %}
                                        {% with current_pct=category_data.total|percentage_of:summary.grand_total target_pct=category_data.target_total|percentage_of:summary.grand_target_total %}
                                        <td class="text-end text-nowrap">{{ current_pct|accounting_percent:1 }}</td>
                                        <td class="text-end text-nowrap">{{ target_pct|accounting_percent:1 }}</td>
                                        <td class="text-end text-nowrap {% if category_data.variance_total >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            {{ current_pct|subtract:target_pct|accounting_percent:1 }}
                                        </td>
                                        {% endwith %}
                                    </tr>
                                    {% endif %}
                                    {% endfor %}
                                    {% if group_data.asset_class_count > 1 %}
                                    <tr class="table-primary fw-bold border-top">
                                        <td>{{ group_data.label|default:group_code }} Total</td>
                                        {% for code, label in account_types %}
                                        {% with current=group_data.account_type_totals|get_item:code target=group_data.account_type_target_totals|get_item:code %}
                                        {% with current_total=summary.account_type_grand_totals|get_item:code target_total=summary.account_type_grand_target_totals|get_item:code %}
                                        {% with current_pct=current|percentage_of:current_total target_pct=target|percentage_of:target_total %}
                                        <td class="text-end">{{ current_pct|accounting_percent:1 }}</td>
                                        <td class="text-end">{{ target_pct|accounting_percent:1 }}</td>
                                        {% with variance_pct=current_pct|subtract:target_pct %}
                                        <td class="text-end {% if variance_pct >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            {{ variance_pct|accounting_percent:1 }}
                                        </td>
                                        {% endwith %}
                                        {% endwith %}
                                        {% endwith %}
                                        {% endwith %}
                                        {% endfor %}
                                        {% with current_pct=group_data.total|percentage_of:summary.grand_total target_pct=group_data.target_total|percentage_of:summary.grand_target_total %}
                                        <td class="text-end text-nowrap">{{ current_pct|accounting_percent:1 }}</td>
                                        <td class="text-end text-nowrap">{{ target_pct|accounting_percent:1 }}</td>
                                        <td class="text-end text-nowrap {% if group_data.variance_total >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            {{ current_pct|subtract:target_pct|accounting_percent:1 }}
                                        </td>
                                        {% endwith %}
                                    </tr>
                                    {% endif %}
                                    {% endfor %}
                                </tbody>
                                <tfoot>
                                    <tr class="table-dark fw-bold">
                                        <td>Grand Total</td>
                                        {% for code, label in account_types %}
                                        {% with current=summary.account_type_grand_totals|get_item:code target=summary.account_type_grand_target_totals|get_item:code %}
                                        {% with current_total=summary.account_type_grand_totals|get_item:code target_total=summary.account_type_grand_target_totals|get_item:code %}
                                        {% with current_pct=current|percentage_of:current_total target_pct=target|percentage_of:target_total %}
                                        <td class="text-end">{{ current_pct|default:"0"|accounting_percent:1 }}</td>
                                        <td class="text-end">{{ target_pct|default:"0"|accounting_percent:1 }}</td>
                                        {% with variance_pct=current_pct|subtract:target_pct %}
                                        <td class="text-end {% if variance_pct >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            {{ variance_pct|default:"0"|accounting_percent:1 }}
                                        </td>
                                        {% endwith %}
                                        {% endwith %}
                                        {% endwith %}
                                        {% endwith %}
                                        {% endfor %}
                                        <td class="text-end text-nowrap">100.0%</td>
                                        <td class="text-end text-nowrap">100.0%</td>
                                        <td class="text-end text-nowrap">0.0%</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endwith %}
{% endblock %}