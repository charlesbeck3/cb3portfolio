{% extends "portfolio/base.html" %}
{% load portfolio_extras %}
{% load humanize %}

{% block title %}Dashboard - Portfol{% endblock %}

{% block content %}
{% with account_count=account_types|length %}
{% widthratio account_count 1 3 as account_value_columns %}
<style>
    .dashboard-content .holdings-table {
        table-layout: fixed;
    }

    .dashboard-content .holdings-table col.col-asset {
        width: var(--asset-col-width, 18%);
    }

    .dashboard-content .holdings-table col.col-account {
        width: calc(
            (100% - var(--asset-col-width, 18%) - var(--total-col-width, 12%))
            / var(--account-columns, 12)
        );
    }

    .dashboard-content .holdings-table col.col-total {
        width: var(--total-col-width, 12%);
        white-space: nowrap;
    }
</style>

<div class="dashboard-content" style="--account-columns: {{ account_value_columns }};">
<div class="row">
    <!-- Sidebar Column -->
    <div class="col-md-2 d-none d-md-block px-0">
        {% include "portfolio/sidebar.html" %}
    </div>

    <!-- Main Content Column -->
    <div class="col-md-10">
        <div class="row">
            <div class="col-md-12">
                <h1>Dashboard</h1>
                <p class="lead">Welcome to your portfolio manager.</p>

                <div class="card mt-4">
                    <div class="card-body">
                        <h5 class="card-title">Quick Actions</h5>
                        <p class="card-text">Manage your assets and view reports.</p>
                        <a href="{% url 'portfolio:holdings' %}" class="btn btn-primary">View Holdings</a>
                        <a href="#" class="btn btn-secondary">Rebalance</a>
                    </div>
                </div>

                <div class="card mt-4">
                    <div class="card-header">
                        Holdings Summary
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-bordered holdings-table">
                                <colgroup>
                                    <col class="col-asset">
                                    {% for code, label in account_types %}
                                    <col class="col-account">
                                    <col class="col-account">
                                    <col class="col-account">
                                    {% endfor %}
                                    <col class="col-total">
                                </colgroup>
                                <thead>
                                    <tr>
                                        <th rowspan="2">Asset Class</th>
                                        {% for code, label in account_types %}
                                        <th colspan="3" class="text-center">{{ label }}</th>
                                        {% endfor %}
                                        <th rowspan="2" class="text-end">Total</th>
                                    </tr>
                                    <tr>
                                        {% for code, label in account_types %}
                                        <th class="text-end">Current</th>
                                        <th class="text-end">Target</th>
                                        <th class="text-end">vTarget</th>
                                        {% endfor %}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for group_code, group_data in summary.groups.items %}
                                    {% for category_code, category_data in group_data.categories.items %}
                                    {% for asset_class_name, asset_class_data in category_data.asset_classes.items %}
                                    <tr class="group-{{ forloop.parentloop.parentloop.counter }}-rows collapse show">
                                        <td class="ps-4">{{ asset_class_name }}</td>
                                        {% for code, label in account_types %}
                                        {% with data=asset_class_data.account_types|get_item:code %}
                                        <td class="text-end">${{ data.current|floatformat:0|default:"0"|intcomma }}</td>
                                        <td class="text-end">${{ data.target|floatformat:0|default:"0"|intcomma }}</td>
                                        <td class="text-end {% if data.variance >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            ${{ data.variance|floatformat:0|default:"0"|intcomma }}
                                        </td>
                                        {% endwith %}
                                        {% endfor %}
                                        <td class="text-end fw-bold">${{ asset_class_data.total|floatformat:0|default:"0"|intcomma }}</td>
                                    </tr>
                                    {% endfor %}
                                    {% if group_data.categories|length > 1 %}
                                    <tr
                                        class="table-secondary fw-bold group-{{ forloop.parentloop.counter }}-rows collapse show">
                                        {% with category_label=summary.category_labels|get_item:category_code %}
                                        <td class="ps-4">{{ category_label|default:category_code }} Total</td>
                                        {% endwith %}
                                        {% for code, label in account_types %}
                                        {% with current=category_data.account_type_totals|get_item:code target=category_data.account_type_target_totals|get_item:code variance=category_data.account_type_variance_totals|get_item:code %}
                                        <td class="text-end">${{ current|floatformat:0|default:"0"|intcomma }}</td>
                                        <td class="text-end">${{ target|floatformat:0|default:"0"|intcomma }}</td>
                                        <td class="text-end {% if variance >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            ${{ variance|floatformat:0|default:"0"|intcomma }}
                                        </td>
                                        {% endwith %}
                                        {% endfor %}
                                        <td class="text-end">${{ category_data.total|floatformat:0|default:"0"|intcomma }}</td>
                                    </tr>
                                    {% endif %}
                                    {% endfor %}
                                    <tr class="table-primary fw-bold border-top group-toggle mt-3"
                                        data-bs-toggle="collapse" data-bs-target=".group-{{ forloop.counter }}-rows"
                                        aria-expanded="true" role="button">
                                        <td>{{ group_data.label|default:group_code }} Total</td>
                                        {% for code, label in account_types %}
                                        {% with current=group_data.account_type_totals|get_item:code target=group_data.account_type_target_totals|get_item:code variance=group_data.account_type_variance_totals|get_item:code %}
                                        <td class="text-end">${{ current|floatformat:0|default:"0"|intcomma }}</td>
                                        <td class="text-end">${{ target|floatformat:0|default:"0"|intcomma }}</td>
                                        <td class="text-end {% if variance >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            ${{ variance|floatformat:0|default:"0"|intcomma }}
                                        </td>
                                        {% endwith %}
                                        {% endfor %}
                                        <td class="text-end">${{ group_data.total|floatformat:0|default:"0"|intcomma }}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot>
                                    <tr class="table-dark fw-bold">
                                        <td>Grand Total</td>
                                        {% for code, label in account_types %}
                                        {% with current=summary.account_type_grand_totals|get_item:code target=summary.account_type_grand_target_totals|get_item:code variance=summary.account_type_grand_variance_totals|get_item:code %}
                                        <td class="text-end">${{ current|floatformat:0|default:"0"|intcomma }}</td>
                                        <td class="text-end">${{ target|floatformat:0|default:"0"|intcomma }}</td>
                                        <td class="text-end {% if variance >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            ${{ variance|floatformat:0|default:"0"|intcomma }}
                                        </td>
                                        {% endwith %}
                                        {% endfor %}
                                        <td class="text-end">
                                            ${{ summary.grand_total|floatformat:0|default:"0"|intcomma }}
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="card mt-3">
                    <div class="card-header">
                        Allocation by Account Type (Percentage)
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-bordered mb-0 holdings-table">
                                <colgroup>
                                    <col class="col-asset">
                                    {% for code, label in account_types %}
                                    <col class="col-account">
                                    <col class="col-account">
                                    <col class="col-account">
                                    {% endfor %}
                                    <col class="col-total">
                                </colgroup>
                                <thead>
                                    <tr>
                                        <th rowspan="2">Asset Class</th>
                                        {% for code, label in account_types %}
                                        <th colspan="3" class="text-center">{{ label }}</th>
                                        {% endfor %}
                                        <th rowspan="2" class="text-end">Total</th>
                                    </tr>
                                    <tr>
                                        {% for code, label in account_types %}
                                        <th class="text-end">Current</th>
                                        <th class="text-end">Target</th>
                                        <th class="text-end">vTarget</th>
                                        {% endfor %}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for group_code, group_data in summary.groups.items %}
                                    {% for category_code, category_data in group_data.categories.items %}
                                    {% for asset_class_name, asset_class_data in category_data.asset_classes.items %}
                                    <tr>
                                        <td class="ps-4">{{ asset_class_name }}</td>
                                        {% for code, label in account_types %}
                                        {% with data=asset_class_data.account_types|get_item:code column_total=summary.account_type_grand_totals|get_item:code %}
                                        {% with current_pct=data.current|percentage_of:column_total target_pct=data.target|percentage_of:column_total %}
                                        <td class="text-end">{{ current_pct|floatformat:1 }}%</td>
                                        <td class="text-end">{{ target_pct|floatformat:1 }}%</td>
                                        {% with variance_pct=current_pct|subtract:target_pct %}
                                        <td class="text-end {% if variance_pct >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            {{ variance_pct|floatformat:1 }}%
                                        </td>
                                        {% endwith %}
                                        {% endwith %}
                                        {% endwith %}
                                        {% endfor %}
                                        <td class="text-end fw-bold">{{ asset_class_data.total|percentage_of:summary.grand_total|floatformat:1 }}%</td>
                                    </tr>
                                    {% endfor %}
                                    {% if group_data.categories|length > 1 %}
                                    <tr class="table-secondary fw-bold">
                                        {% with category_label=summary.category_labels|get_item:category_code %}
                                        <td class="ps-4">{{ category_label|default:category_code }} Total</td>
                                        {% endwith %}
                                        {% for code, label in account_types %}
                                        {% with current=category_data.account_type_totals|get_item:code target=category_data.account_type_target_totals|get_item:code variance=category_data.account_type_variance_totals|get_item:code %}
                                        {% with current_total=summary.account_type_grand_totals|get_item:code target_total=summary.account_type_grand_target_totals|get_item:code %}
                                        {% with current_pct=current|percentage_of:current_total target_pct=target|percentage_of:target_total %}
                                        <td class="text-end">{{ current_pct|floatformat:1 }}%</td>
                                        <td class="text-end">{{ target_pct|floatformat:1 }}%</td>
                                        {% with variance_pct=current_pct|subtract:target_pct %}
                                        <td class="text-end {% if variance_pct >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            {{ variance_pct|floatformat:1 }}%
                                        </td>
                                        {% endwith %}
                                        {% endwith %}
                                        {% endwith %}
                                        {% endwith %}
                                        {% endfor %}
                                        <td class="text-end">{{ category_data.total|percentage_of:summary.grand_total|floatformat:1 }}%</td>
                                    </tr>
                                    {% endif %}
                                    {% endfor %}
                                    <tr class="table-primary fw-bold border-top">
                                        <td>{{ group_data.label|default:group_code }} Total</td>
                                        {% for code, label in account_types %}
                                        {% with current=group_data.account_type_totals|get_item:code target=group_data.account_type_target_totals|get_item:code %}
                                        {% with current_total=summary.account_type_grand_totals|get_item:code target_total=summary.account_type_grand_target_totals|get_item:code %}
                                        {% with current_pct=current|percentage_of:current_total target_pct=target|percentage_of:target_total %}
                                        <td class="text-end">{{ current_pct|floatformat:1 }}%</td>
                                        <td class="text-end">{{ target_pct|floatformat:1 }}%</td>
                                        {% with variance_pct=current_pct|subtract:target_pct %}
                                        <td class="text-end {% if variance_pct >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            {{ variance_pct|floatformat:1 }}%
                                        </td>
                                        {% endwith %}
                                        {% endwith %}
                                        {% endwith %}
                                        {% endwith %}
                                        {% endfor %}
                                        <td class="text-end">{{ group_data.total|percentage_of:summary.grand_total|floatformat:1 }}%</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot>
                                    <tr class="table-dark fw-bold">
                                        <td>Grand Total</td>
                                        {% for code, label in account_types %}
                                        {% with current=summary.account_type_grand_totals|get_item:code target=summary.account_type_grand_target_totals|get_item:code %}
                                        {% with current_total=summary.account_type_grand_totals|get_item:code target_total=summary.account_type_grand_target_totals|get_item:code %}
                                        {% with current_pct=current|percentage_of:current_total target_pct=target|percentage_of:target_total %}
                                        <td class="text-end">{{ current_pct|default:"0"|floatformat:1 }}%</td>
                                        <td class="text-end">{{ target_pct|default:"0"|floatformat:1 }}%</td>
                                        {% with variance_pct=current_pct|subtract:target_pct %}
                                        <td class="text-end {% if variance_pct >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            {{ variance_pct|default:"0"|floatformat:1 }}%
                                        </td>
                                        {% endwith %}
                                        {% endwith %}
                                        {% endwith %}
                                        {% endwith %}
                                        {% endfor %}
                                        {% with target_total=summary.grand_target_total current_total=summary.grand_total %}
                                        {% with current_pct=current_total|percentage_of:current_total target_pct=target_total|percentage_of:target_total %}
                                        <td class="text-end">100%</td>
                                        {% endwith %}
                                        {% endwith %}
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endwith %}
{% endblock %}