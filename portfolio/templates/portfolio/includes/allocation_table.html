{% load portfolio_extras %}
{% load humanize %}

<table class="table table-bordered table-striped table-hover mb-0 align-middle" id="{{ table_id }}" style="font-size: 0.8rem;">
    <thead class="table-light">
        <tr>
            <th scope="col" class="ps-4" rowspan="2" style="width: 250px; min-width: 250px; white-space: nowrap;">Asset Class</th>
            {% for at in account_types %}
                <!-- Account Type Header -->
                <th scope="col" class="text-center border-bottom-0 position-relative" colspan="4">
                    {{ at.label }}
                    {% if at.active_accounts and mode == 'percent' %}
                    <button type="button" class="btn btn-sm btn-link p-0 ms-2 text-decoration-none expand-btn" 
                            data-at-id="{{ at.id }}" title="Show/Hide Individual Accounts">
                        [+]
                    </button>
                    {% endif %}
                </th>
                <!-- Individual Accounts Headers -->
                {% for acc in at.active_accounts %}
                    <th scope="col" class="text-center border-bottom-0 table-warning d-none col-acc-{{ at.id }}" colspan="3">
                        <small>{{ acc.name }}</small>
                    </th>
                {% endfor %}
            {% endfor %}
            <th scope="col" class="text-center table-active border-bottom-0" colspan="3">Total Portfolio ({% if mode == 'percent' %}%{% else %}${% endif %})</th>
        </tr>
        <tr>
            {% for at in account_types %}
                <!-- Account Type Sub-headers -->
                <th scope="col" class="text-center small border-top-0 text-muted" style="min-width: 50px;">Current</th>
                <th scope="col" class="text-center small border-top-0 text-muted" style="min-width: 90px;">Target</th>
                <th scope="col" class="text-center small border-top-0 text-muted" style="min-width: 60px;">Wt. Target</th>
                <th scope="col" class="text-center small border-top-0 text-muted" style="min-width: 50px;">Variance</th>
                
                <!-- Individual Accounts Sub-headers -->
                {% for acc in at.active_accounts %}
                    <th scope="col" class="text-center small border-top-0 text-muted table-warning d-none col-acc-{{ at.id }}" style="min-width: 50px;">Curr</th>
                    <th scope="col" class="text-center small border-top-0 text-muted table-warning d-none col-acc-{{ at.id }}" style="min-width: 80px;">{% if mode == 'percent' %}Override{% else %}Target{% endif %}</th>
                    <th scope="col" class="text-center small border-top-0 text-muted table-warning d-none col-acc-{{ at.id }}" style="min-width: 50px;">{% if mode == 'percent' %}Eff{% else %}Var{% endif %}</th>
                {% endfor %}
            {% endfor %}
            
            <th scope="col" class="text-center small table-active border-top-0 text-muted" style="min-width: 50px;">Curr</th>
            <th scope="col" class="text-center small table-active border-top-0 text-muted" style="min-width: 60px;">Target</th>
            <th scope="col" class="text-center small table-active border-top-0 text-muted" style="min-width: 50px;">Var</th>
        </tr>
    </thead>
    <tbody>
        {% for group_code, group_data in summary.groups.items %}
            <!-- Groups -->
            {% for category_code, cat_data in group_data.categories.items %}
                 <!-- Assets -->
                 {% for ac_name, ac_data in cat_data.asset_classes.items %}
                    {% if ac_data.id != cash_asset_class_id %}
                    <tr data-ac-id="{{ ac_data.id }}" data-category-code="{{ category_code }}">
                        <td class="ps-4">{{ ac_name }}</td>
                        {% for at in account_types %}
                            <!-- 1. Account Type Columns -->
                            <!-- Current -->
                            {% with at_data=ac_data.account_types|get_item:at.code %}
                            <td class="text-end pe-1 text-muted small" 
                                {% if mode == 'percent' %}data-at-current="{{ at_data.current|default:0 }}"{% endif %}>
                                {% if mode == 'percent' %}
                                    {% if at.current_total_value > 0 %}
                                        {{ at_data.current|percentage_of:at.current_total_value|accounting_percent:1 }}
                                    {% else %}
                                        0.0%
                                    {% endif %}
                                {% else %}
                                    <!-- Dollar Mode -->
                                    {{ at.dollar_map|get_item:ac_data.id|default:0|accounting_amount:0 }}
                                {% endif %}
                            </td>
                            {% endwith %}

                            <!-- Default Input / Target $ -->
                            <td class="{% if mode == 'percent' %}p-1{% else %}text-end pe-1 small text-muted{% endif %}">
                                {% if mode == 'percent' %}
                                    <div class="input-group input-group-sm">
                                        <input type="number" 
                                               name="target_{{ at.id }}_{{ ac_data.id }}" 
                                               step="0.01" 
                                               min="0" 
                                               max="100" 
                                               class="form-control form-control-sm text-end default-input px-1"
                                               data-at-id="{{ at.id }}"
                                               data-ac-id="{{ ac_data.id }}"
                                               value="{{ at.target_map|get_item:ac_data.id|default:'' }}"
                                               placeholder="--">
                                    </div>
                                {% else %}
                                    <span id="{{ id_prefix }}def-{{ at.id }}-{{ ac_data.id }}">--</span>
                                {% endif %}
                            </td>
                            
                            <!-- Aggregated % / Aggregated Target $ -->
                            <td class="text-end pe-1 small fw-bold text-muted d-none d-md-table-cell agg-cell">
                                <span id="{{ id_prefix }}agg-{{ at.id }}-{{ ac_data.id }}">--</span>
                            </td>

                            <!-- Variance -->
                            <td class="text-end pe-1 small fw-bold">
                                <span id="{{ id_prefix }}var-{{ at.id }}-{{ ac_data.id }}">--</span>
                            </td>
                            
                            <!-- Individual Accounts -->
                            {% for acc in at.active_accounts %}
                                <!-- Current -->
                                <td class="text-end pe-1 text-muted small table-warning d-none col-acc-{{ at.id }}">
                                     {% if mode == 'percent' %}
                                         {% if acc.current_total_value > 0 %}
                                            {{ acc.dollar_map|get_item:ac_data.id|default:0|percentage_of:acc.current_total_value|accounting_percent:1 }}
                                         {% else %}
                                            0.0%
                                         {% endif %}
                                     {% else %}
                                         {{ acc.dollar_map|get_item:ac_data.id|default:0|accounting_amount:0 }}
                                     {% endif %}
                                </td>
                                <!-- Override Input / Target $ -->
                                <td class="{% if mode == 'percent' %}p-1{% else %}text-end pe-1 small{% endif %} table-warning d-none col-acc-{{ at.id }}">
                                    {% if mode == 'percent' %}
                                        <input type="number"
                                               name="target_account_{{ acc.id }}_{{ ac_data.id }}"
                                               step="0.01"
                                               min="0"
                                               max="100"
                                               class="form-control form-control-sm text-end override-input px-1"
                                               data-acc-id="{{ acc.id }}"
                                               data-at-id="{{ at.id }}"
                                               data-ac-id="{{ ac_data.id }}"
                                               value="{{ acc.target_map|get_item:ac_data.id|default:'' }}"
                                               placeholder="--">
                                    {% else %}
                                         <span id="{{ id_prefix }}target-{{ acc.id }}-{{ ac_data.id }}">--</span>
                                    {% endif %}
                                </td>
                                <!-- Effective % / Variance $ -->
                                <td class="text-end pe-2 small table-warning d-none col-acc-{{ at.id }}">
                                    <span id="{{ id_prefix }}{% if mode == 'percent' %}eff{% else %}var{% endif %}-{{ acc.id }}-{{ ac_data.id }}" 
                                          class="{% if mode == 'percent' %}text-muted{% endif %}">--</span>
                                </td>
                            {% endfor %}
                        {% endfor %}
                        
                        <!-- PORTFOLIO TOTALS -->
                        <td class="text-end pe-2 table-active text-muted">
                            {% if mode == 'percent' %}
                                {{ ac_data.total|percentage_of:portfolio_total_value|accounting_percent:1 }}
                            {% else %}
                                {{ ac_data.total|accounting_amount:0 }}
                            {% endif %}
                        </td>
                        <td class="text-end pe-2 table-active">
                            <span id="{{ id_prefix }}row-total-{{ ac_data.id }}">{% if mode == 'percent' %}0.00%{% else %}--{% endif %}</span>
                        </td>
                        <td class="text-end pe-2 table-active fw-bold">
                            <span id="{{ id_prefix }}row-var-{{ ac_data.id }}">{% if mode == 'percent' %}0.00%{% else %}--{% endif %}</span>
                        </td>
                    </tr>
                    {% endif %}
                {% endfor %}

                <!-- Subtotal Row for Category -->
                {% with category_label=summary.category_labels|get_item:category_code %}
                {% if cat_data.asset_classes|length > 1 %}
                <tr class="table-info fw-bold category-subtotal-{{ category_code }}">
                    <td class="ps-4 text-dark">{{ category_label|default:category_code }} Total</td>
                    {% for at in account_types %}
                        <!-- Account Type Subtotals -->
                        <td class="text-end pe-1 small text-dark">
                            {% if mode == 'percent' %}
                                <span id="{{ id_prefix }}sub-curr-{{ at.id }}-{{ category_code }}">
                                    {% with at_data=cat_data.account_type_totals|get_item:at.code %}
                                        {% if at.current_total_value > 0 %}
                                            {{ at_data|percentage_of:at.current_total_value|accounting_percent:1 }}
                                        {% else %}
                                            0.0%
                                        {% endif %}
                                    {% endwith %}
                                </span>
                            {% else %}
                                <!-- Dollar Mode -->
                                {% with at_data=cat_data.account_type_totals|get_item:at.code %}
                                    {{ at_data|default:0|accounting_amount:0 }}
                                {% endwith %}
                            {% endif %}
                        </td>
                        <td class="text-end pe-1 small text-dark">
                             <!-- Default Target Sum (JS) -->
                             <span id="{{ id_prefix }}sub-def-{{ at.id }}-{{ category_code }}">--</span>
                        </td>
                        <td class="text-end pe-1 small text-dark d-none d-md-table-cell">
                             <!-- Aggregated Target Sum (JS) -->
                             <span id="{{ id_prefix }}sub-agg-{{ at.id }}-{{ category_code }}">--</span>
                        </td>
                        <td class="text-end pe-1 small text-dark">
                             <!-- Variance Sum (JS) -->
                             <span id="{{ id_prefix }}sub-var-{{ at.id }}-{{ category_code }}">--</span>
                        </td>
                        
                        <!-- Individual Accounts Subtotals -->
                        {% for acc in at.active_accounts %}
                            <td class="text-end pe-1 small table-warning d-none col-acc-{{ at.id }} text-dark">
                                {% if mode == 'percent' %}
                                    {% if acc.current_total_value > 0 %}
                                       {{ acc.category_map|get_item:category_code|default:0|percentage_of:acc.current_total_value|accounting_percent:1 }}
                                    {% else %}
                                       0.0%
                                    {% endif %}
                                {% else %}
                                   {{ acc.category_map|get_item:category_code|default:0|accounting_amount:0 }}
                                {% endif %}
                            </td>
                            <td class="text-end pe-1 small table-warning d-none col-acc-{{ at.id }} text-dark">
                                 <!-- Override/Target Sum (JS) -->
                                 <span id="{{ id_prefix }}sub-{% if mode == 'percent' %}over{% else %}target{% endif %}-{{ acc.id }}-{{ category_code }}">--</span>
                            </td>
                            <td class="text-end pe-2 small table-warning d-none col-acc-{{ at.id }} text-dark">
                                 <!-- Effective/Var Sum (JS) -->
                                 <span id="{{ id_prefix }}sub-{% if mode == 'percent' %}eff{% else %}var{% endif %}-{{ acc.id }}-{{ category_code }}">--</span>
                            </td>
                        {% endfor %}
                    {% endfor %}
                    
                    <!-- Portfolio Totals Subtotal -->
                    <td class="text-end pe-2 table-active text-dark">
                        {% if mode == 'percent' %}
                             <span id="{{ id_prefix }}sub-total-curr-{{ category_code }}">{{ cat_data.total|percentage_of:portfolio_total_value|accounting_percent:1 }}</span>
                        {% else %}
                             {{ cat_data.total|accounting_amount:0 }}
                        {% endif %}
                    </td>
                    <td class="text-end pe-2 table-active text-dark">
                        <span id="{{ id_prefix }}sub-total-target-{{ category_code }}">--</span>
                    </td>
                    <td class="text-end pe-2 table-active text-dark">
                        <span id="{{ id_prefix }}sub-total-var-{{ category_code }}">--</span>
                    </td>
                </tr>
                {% endif %}
                {% endwith %}
            {% endfor %}
        {% endfor %}
        
        <!-- Cash Row | We reuse the generic loop? No, Cash is special computed row. -->
        <!-- We can copy the logic but ID prefixes must be correct. -->
        
        <tr class="table-warning fw-bold border-top-2" data-ac-id="cash">
            <td class="ps-4">Cash (Calculated)</td>
            {% for at in account_types %}
                <!-- Current -->
                <td class="text-end pe-2 text-muted small"
                    {% if mode == 'percent' %}data-at-current="{{ at.allocation_map|get_item:cash_asset_class_id|default:0 }}"{% endif %}>
                    {% if mode == 'percent' %}
                        {{ at.allocation_map|get_item:cash_asset_class_id|default:0|accounting_percent:1 }}
                    {% else %}
                       {{ at.dollar_map|get_item:cash_asset_class_id|default:0|accounting_amount:0 }}
                    {% endif %}
                </td>
                <td class="text-end pe-2">
                    <span id="{{ id_prefix }}cash-default-{{ at.id }}">{% if mode == 'percent' %}100%{% else %}--{% endif %}</span>
                </td>
                <!-- Aggregated -->
                <td class="text-end pe-2">
                    <span id="{{ id_prefix }}cash-agg-{{ at.id }}">{% if mode == 'percent' %}0.0%{% else %}--{% endif %}</span>
                </td>
                <td class="text-end pe-2">
                    <span id="{{ id_prefix }}cash-var-{{ at.id }}">{% if mode == 'percent' %}0.0%{% else %}--{% endif %}</span>
                </td>
                
                {% for acc in at.active_accounts %}
                    <!-- CASH: Current (Calculated from Holdings) -->
                    <td class="text-end pe-2 d-none col-acc-{{ at.id }} text-muted small table-warning">
                         {% if mode == 'percent' %}
                             {{ acc.allocation_map|get_item:cash_asset_class_id|default:0|accounting_percent:1 }}
                         {% else %}
                             {{ acc.dollar_map|get_item:cash_asset_class_id|default:0|accounting_amount:0 }}
                         {% endif %}
                    </td>
                    
                    <!-- CASH: Override Input / Target -->
                    <td class="{% if mode == 'percent' %}p-1{% else %}text-end pe-2{% endif %} table-warning d-none col-acc-{{ at.id }}">
                        {% if mode == 'percent' %}
                             <input type="number"
                                   name="target_account_{{ acc.id }}_{{ cash_asset_class_id }}"
                                   step="0.01"
                                   min="0"
                                   max="100"
                                   class="form-control form-control-sm text-end override-input px-1"
                                   data-acc-id="{{ acc.id }}"
                                   data-at-id="{{ at.id }}"
                                   data-ac-id="cash"
                                   value="{{ acc.target_map|get_item:cash_asset_class_id|default:'' }}"
                                   placeholder="--">
                        {% else %}
                             <span id="{{ id_prefix }}cash-target-{{ acc.id }}">--</span>
                        {% endif %}
                    </td>

                    <!-- CASH: Effective / Var -->
                    <td class="text-end pe-2 d-none col-acc-{{ at.id }} table-warning">
                        <span id="{{ id_prefix }}cash-{% if mode == 'percent' %}eff{% else %}var{% endif %}-{{ acc.id }}">
                            {% if mode == 'percent' %}100%{% else %}--{% endif %}
                        </span>
                    </td>
                {% endfor %}
            {% endfor %}
            
            <td class="text-end pe-2 table-active">
                {% if mode == 'percent' %}
                    <span id="{{ id_prefix }}cash-current">--</span>
                {% else %}
                    {{ current_cash_total|accounting_amount:0 }}
                {% endif %}
            </td>
            <td class="text-end pe-2 table-active">
                <span id="{{ id_prefix }}cash-total">{% if mode == 'percent' %}0.00%{% else %}--{% endif %}</span>
            </td>
            <td class="text-end pe-2 table-active">
                 <span id="{{ id_prefix }}cash{% if mode == 'dollar' %}-total{% endif %}-var">{% if mode == 'percent' %}0.00%{% else %}--{% endif %}</span>
            </td>
        </tr>

        <!-- Total Row -->
        <tr class="table-light border-top fw-bold">
            <td class="ps-4">Total</td>
            {% for at in account_types %}
                <td class="text-end pe-2">
                    {% if mode == 'percent' %}100%{% else %}{{ at.active_accounts|length|yesno:" ,," }}{{ at.current_total_value|default:0|accounting_amount:0 }}{% endif %}
                </td>
                <td class="text-end pe-2">
                    <span id="{{ id_prefix }}total-default-{{ at.id }}" class="{% if mode == 'percent' %}total-display{% endif %}">{% if mode == 'percent' %}0.00%{% else %}--{% endif %}</span>
                </td>
                <td class="text-end pe-2">
                    <span id="{{ id_prefix }}total-agg-{{ at.id }}">{% if mode == 'percent' %}0.00%{% else %}--{% endif %}</span>
                </td>
                <td class="text-end pe-2">
                    <span id="{{ id_prefix }}total-var-{{ at.id }}">{% if mode == 'percent' %}0.00%{% else %}--{% endif %}</span>
                </td>
                {% for acc in at.active_accounts %}
                    <td class="{% if mode == 'dollar' %}text-end pe-2{% endif %} d-none col-acc-{{ at.id }}">
                         {% if mode == 'dollar' %}{{ acc.current_total_value|default:0|accounting_amount:0 }}{% endif %}
                    </td>
                    <td class="text-end pe-2 d-none col-acc-{{ at.id }}">
                         <span id="{{ id_prefix }}total-{% if mode == 'percent' %}eff{% else %}target{% endif %}-{{ acc.id }}">{% if mode == 'percent' %}100%{% else %}--{% endif %}</span>
                    </td>
                    <td class="d-none col-acc-{{ at.id }}"></td>
                {% endfor %}
            {% endfor %}
            
            <td class="text-end pe-2 table-active">
                {% if mode == 'percent' %}100.0%{% else %}{{ portfolio_total_value|accounting_amount:0 }}{% endif %}
            </td>
            <td class="text-end pe-2 table-active">
                {% if mode == 'percent' %}100.0%{% else %}<span id="{{ id_prefix }}grand-total-target">--</span>{% endif %}
            </td>
            <td class="text-end pe-2 table-active">
                {% if mode == 'percent' %}0.0%{% else %}--{% endif %}
            </td>
        </tr>
    </tbody>
</table>
