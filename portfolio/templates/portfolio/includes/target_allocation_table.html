{% with account_types=rows.0.account_types %}
<table class="table table-bordered table-striped table-hover mb-0 align-middle" id="{{ table_id }}" style="font-size: 0.8rem; table-layout: fixed;">
    <thead class="table-light">
        <tr>
            <th scope="col" class="ps-4" rowspan="2" style="width: 250px; min-width: 250px; white-space: nowrap;">Asset Class</th>
            {% for group in account_types %}
                <th scope="col" class="text-center border-bottom-0 position-relative pb-3" colspan="3">
                    <div>{{ group.label }}</div>
                    <div class="fw-normal mt-1">
                        {% if mode == 'percent' %}
                        <select name="strategy_at_{{ group.id }}" class="form-select form-select-sm d-inline-block w-auto py-0 px-2" style="font-size: 0.75rem;">
                            <option value="">-- Unassigned --</option>
                            {% for s in strategies %}
                                <option value="{{ s.id }}" {% if s.id == group.active_strategy_id %}selected{% endif %}>{{ s.name }}</option>
                            {% endfor %}
                        </select>
                        {% else %}
                            <span class="badge bg-light text-dark border fw-normal">
                                {% for s in strategies %}
                                    {% if s.id == group.active_strategy_id %}{{ s.name }}{% endif %}
                                {% empty %}
                                    -- Unassigned --
                                {% endfor %}
                                {% if not group.active_strategy_id %}-- Unassigned --{% endif %}
                            </span>
                        {% endif %}
                    </div>
                    {% if group.active_accounts and mode == 'percent' %}
                    <button type="button" class="btn btn-sm btn-link p-0 ms-2 text-decoration-none expand-btn position-absolute top-0 end-0 mt-1 me-1" data-at-id="{{ group.id }}" title="Show/Hide Individual Accounts">[+]</button>
                    {% endif %}
                </th>
                {% for acc in group.active_accounts %}
                    <th scope="col" class="text-center border-bottom-0 table-warning d-none col-acc-{{ group.id }} pb-3" colspan="3">
                        <div><small>{{ acc.name }}</small></div>
                        <div class="fw-normal mt-1">
                            {% if mode == 'percent' %}
                            <select name="strategy_acc_{{ acc.id }}" class="form-select form-select-sm d-inline-block w-auto py-0 px-2" style="font-size: 0.75rem;">
                                <option value="">-- Use Default (Type Strategy) --</option>
                                {% for s in strategies %}
                                    <option value="{{ s.id }}" {% if acc.allocation_strategy_id == s.id %}selected{% endif %}>{{ s.name }}</option>
                                {% endfor %}
                            </select>
                            {% else %}
                                <span class="badge bg-light text-dark border fw-normal">
                                    {% if acc.allocation_strategy_id %}
                                        {% for s in strategies %}
                                            {% if s.id == acc.allocation_strategy_id %}{{ s.name }}{% endif %}
                                        {% endfor %}
                                    {% else %}
                                        Use Default
                                    {% endif %}
                                </span>
                            {% endif %}
                        </div>
                    </th>
                {% endfor %}
            {% endfor %}
            <th scope="col" class="text-center table-active border-bottom-0" colspan="3">Total Portfolio ({% if mode == 'percent' %}%{% else %}${% endif %})</th>
        </tr>
        <tr>
            {% for group in account_types %}
                <th scope="col" class="text-center small border-top-0 text-muted" style="width: 60px; min-width: 60px;">Actual</th>
                <th scope="col" class="text-center small border-top-0 text-muted col-mode-policy d-none" style="width: 90px; min-width: 90px;">Policy</th>
                <th scope="col" class="text-center small border-top-0 text-muted col-mode-effective" style="width: 70px; min-width: 70px;">Effective</th>
                <th scope="col" class="text-center small border-top-0 text-muted variance-col" style="width: 70px; min-width: 70px;">Variance</th>
                {% for _acc in group.active_accounts %}
                    <th scope="col" class="text-center small border-top-0 text-muted table-warning d-none col-acc-{{ group.id }}" style="width: 60px; min-width: 60px;">Actual</th>
                    <th scope="col" class="text-center small border-top-0 text-muted table-warning d-none col-acc-{{ group.id }}" style="width: 90px; min-width: 90px;">Policy</th>
                    <th scope="col" class="text-center small border-top-0 text-muted table-warning d-none col-acc-{{ group.id }}" style="width: 70px; min-width: 70px;">Variance</th>
                {% endfor %}
            {% endfor %}
            <th scope="col" class="text-center small table-active border-top-0 text-muted" style="width: 60px; min-width: 60px;">Actual</th>
            <th scope="col" class="text-center small table-active border-top-0 text-muted col-mode-policy d-none" style="width: 70px; min-width: 70px;">Policy</th>
            <th scope="col" class="text-center small table-active border-top-0 text-muted col-mode-effective" style="width: 70px; min-width: 70px;">Effective</th>
            <th scope="col" class="text-center small table-active border-top-0 text-muted variance-col" style="width: 70px; min-width: 70px;">Variance</th>
        </tr>
    </thead>
    <tbody>
        {% for row in rows %}
        <tr {% if row.is_subtotal %}class="table-info fw-bold"{% elif row.is_group_total %}class="fw-bold" style="background-color: #e2e3e5;"{% elif row.is_grand_total %}class="table-dark fw-bold"{% endif %}>
            <td class="ps-4">{{ row.asset_class_name }}</td>

            {% for group in row.account_types %}
                <td class="text-end pe-1 small {% if row.is_grand_total %}text-white{% elif row.is_subtotal or row.is_group_total %}text-dark{% else %}text-muted{% endif %}">{{ group.actual|safe }}</td>

                <td class="text-end pe-1 small {% if row.is_grand_total %}text-white{% endif %} col-mode-policy d-none">
                    {{ group.policy|default:"--"|safe }}
                </td>

                <td class="text-end pe-1 small fw-bold {% if row.is_grand_total %}text-white{% else %}text-muted{% endif %} col-mode-effective">{{ group.effective|safe }}</td>
                <td class="text-end pe-1 small fw-bold variance-col"
                    data-effective-variance="{{ group.effective_variance|safe }}"
                    data-policy-variance="{{ group.policy_variance|safe }}"
                    data-effective-variance-pct="{{ group.effective_variance_pct }}"
                    data-policy-variance-pct="{{ group.policy_variance_pct }}">
                    <span class="variance-value">{{ group.effective_variance|safe }}</span>
                </td>

                {% for acc in group.accounts %}
                    <td class="text-end pe-1 small table-warning d-none col-acc-{{ group.id }}">{{ acc.actual|safe }}</td>
                    <td class="text-end pe-1 small table-warning d-none col-acc-{{ group.id }}">
                        {{ acc.policy|safe }}
                    </td>
                    <td class="text-end pe-2 small table-warning d-none col-acc-{{ group.id }}">
                         <!-- Individual accounts only have policy variance -->
                         <span class="variance-value">{{ acc.policy_variance|safe }}</span>
                    </td>
                {% endfor %}
            {% endfor %}

            <td class="text-end pe-2 table-active {% if row.is_grand_total %}text-white{% elif row.is_subtotal or row.is_group_total %}text-dark{% else %}text-muted{% endif %}">{{ row.portfolio.actual|safe }}</td>
            <td class="text-end pe-1 table-active small {% if row.is_grand_total %}text-white{% else %}text-muted{% endif %} col-mode-policy d-none"
                {% if row.is_cash %}id="cash-exp-target"
                {% elif row.is_subtotal %}id="sub-total-exp-target-{{ row.category_code }}"
                {% elif not row.is_group_total and not row.is_grand_total %}id="row-exp-target-{{ row.asset_class_id }}"{% endif %}
            >{{ row.portfolio.explicit_target|safe }}</td>
            <td class="text-end pe-1 table-active small {% if row.is_grand_total %}text-white{% endif %} col-mode-effective"
                data-category-code="{{ row.category_code }}"
                {% if row.is_cash %}id="cash-total"
                {% elif row.is_subtotal %}id="sub-total-target-{{ row.category_code }}"
                {% elif not row.is_group_total and not row.is_grand_total %}id="row-total-{{ row.asset_class_id }}"{% endif %}
            >{{ row.portfolio.effective|safe }}</td>
            <td class="text-end pe-2 table-active fw-bold variance-col"
                data-effective-variance="{{ row.portfolio.effective_variance|safe }}"
                data-policy-variance="{{ row.portfolio.policy_variance|safe }}"
                data-effective-variance-pct="{{ row.portfolio.effective_variance_pct }}"
                data-policy-variance-pct="{{ row.portfolio.policy_variance_pct }}"
                data-category-code="{{ row.category_code }}"
                {% if row.is_cash %}id="cash-var"
                {% elif row.is_subtotal %}id="sub-total-var-{{ row.category_code }}"
                {% elif not row.is_group_total and not row.is_grand_total %}id="row-var-{{ row.asset_class_id }}"{% endif %}
            >
                <span class="variance-value">{{ row.portfolio.effective_variance|safe }}</span>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endwith %}
