{% load allocation_tags portfolio_filters %}
{% if rows %}
    {% with account_types=rows.0.account_types %}
    <table class="table table-bordered table-striped table-hover mb-0 align-middle" id="{{ table_id }}" style="font-size: 0.8rem; table-layout: fixed;">
        <thead class="table-light">
            <tr>
                <th scope="col" class="ps-4" style="width: 250px; min-width: 250px; white-space: nowrap;">Asset Class</th>
                {% for at in account_types %}
                    <th scope="col" class="text-center" colspan="3">{{ at.label }}</th>
                {% endfor %}
                <th scope="col" class="text-center table-active" colspan="3">Total Portfolio ({% if mode == 'percent' %}%{% else %}${% endif %})</th>
            </tr>
            <tr>
                <th></th>
                {% for at in account_types %}
                    <th scope="col" class="text-center small text-muted">Actual</th>
                    <th scope="col" class="text-center small text-muted col-mode-policy d-none">Policy</th>
                    <th scope="col" class="text-center small text-muted col-mode-effective">Effective</th>
                    <th scope="col" class="text-center small text-muted">Variance</th>
                {% endfor %}
                <th scope="col" class="text-center small table-active text-muted">Actual</th>
                <th scope="col" class="text-center small table-active text-muted col-mode-policy d-none">Policy</th>
                <th scope="col" class="text-center small table-active text-muted col-mode-effective">Effective</th>
                <th scope="col" class="text-center small table-active text-muted">Variance</th>
            </tr>
        </thead>
        <tbody>
            {% for row in rows %}
            <tr class="{{ row.row_type|row_css_class }}">
                <td class="ps-4">{{ row.asset_class_name }}</td>
                {% for at_col in row.account_types %}
                    <td class="text-end pe-1 small {% if row.is_grand_total %}text-white{% elif row.is_subtotal or row.is_group_total %}text-dark{% else %}text-muted{% endif %}">
                        {% if mode == 'percent' %}
                            {{ at_col.actual_pct|accounting_percent:1 }}
                        {% else %}
                            {{ at_col.actual|accounting_amount:0 }}
                        {% endif %}
                    </td>
                    <td class="text-end pe-1 small col-mode-policy d-none {% if row.is_grand_total %}text-white{% endif %}">
                        {% if mode == 'percent' %}
                            {{ at_col.policy_pct|accounting_percent:1 }}
                        {% else %}
                            {{ at_col.policy|accounting_amount:0 }}
                        {% endif %}
                    </td>
                    <td class="text-end pe-1 small col-mode-effective {% if row.is_grand_total %}text-white{% endif %}">
                        {% if mode == 'percent' %}
                            {{ at_col.effective_pct|accounting_percent:1 }}
                        {% else %}
                            {{ at_col.effective|accounting_amount:0 }}
                        {% endif %}
                    </td>
                    <td class="text-end pe-1 small fw-bold variance-col {% if mode == 'percent' %}{{ at_col.effective_variance_pct|variance_css_class }}{% else %}{{ at_col.effective_variance|variance_css_class }}{% endif %} {% if row.is_grand_total %}text-white{% endif %}"
                        data-effective-variance="{% if mode == 'percent' %}{{ at_col.effective_variance_pct|accounting_percent:1 }}{% else %}{{ at_col.effective_variance|accounting_amount:0 }}{% endif %}"
                        data-policy-variance="{% if mode == 'percent' %}{{ at_col.policy_variance_pct|accounting_percent:1 }}{% else %}{{ at_col.policy_variance|accounting_amount:0 }}{% endif %}">
                        <span class="variance-value">
                            {% if mode == 'percent' %}
                                {{ at_col.effective_variance_pct|accounting_percent:1 }}
                            {% else %}
                                {{ at_col.effective_variance|accounting_amount:0 }}
                            {% endif %}
                        </span>
                    </td>
                {% endfor %}
                <td class="text-end pe-2 table-active {% if row.is_grand_total %}text-white{% elif row.is_subtotal or row.is_group_total %}text-dark{% else %}text-muted{% endif %}">
                    {% if mode == 'percent' %}
                        {{ row.portfolio.actual_pct|accounting_percent:1 }}
                    {% else %}
                        {{ row.portfolio.actual|accounting_amount:0 }}
                    {% endif %}
                </td>
                <td class="text-end pe-2 table-active col-mode-policy d-none {% if row.is_grand_total %}text-white{% endif %}">
                    {% if mode == 'percent' %}
                        {{ row.portfolio.explicit_target_pct|accounting_percent:1 }}
                    {% else %}
                        {{ row.portfolio.explicit_target|accounting_amount:0 }}
                    {% endif %}
                </td>
                <td class="text-end pe-2 table-active col-mode-effective {% if row.is_grand_total %}text-white{% endif %}">
                    {% if mode == 'percent' %}
                        {{ row.portfolio.effective_pct|accounting_percent:1 }}
                    {% else %}
                        {{ row.portfolio.effective|accounting_amount:0 }}
                    {% endif %}
                </td>
                <td class="text-end pe-2 table-active fw-bold variance-col {% if mode == 'percent' %}{{ row.portfolio.effective_variance_pct|variance_css_class }}{% else %}{{ row.portfolio.effective_variance|variance_css_class }}{% endif %} {% if row.is_grand_total %}text-white{% endif %}"
                    data-effective-variance="{% if mode == 'percent' %}{{ row.portfolio.effective_variance_pct|accounting_percent:1 }}{% else %}{{ row.portfolio.effective_variance|accounting_amount:0 }}{% endif %}"
                    data-policy-variance="{% if mode == 'percent' %}{{ row.portfolio.policy_variance_pct|accounting_percent:1 }}{% else %}{{ row.portfolio.policy_variance|accounting_amount:0 }}{% endif %}">
                    <span class="variance-value">
                        {% if mode == 'percent' %}
                            {{ row.portfolio.effective_variance_pct|accounting_percent:1 }}
                        {% else %}
                            {{ row.portfolio.effective_variance|accounting_amount:0 }}
                        {% endif %}
                    </span>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endwith %}
{% else %}
    <p class="text-muted">No holdings data available.</p>
{% endif %}
