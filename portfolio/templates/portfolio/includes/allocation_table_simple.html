{% load allocation_tags %}
{% if rows %}
    {% with account_types=rows.0.account_types %}
    <table class="table table-bordered table-striped table-hover mb-0 align-middle" id="{{ table_id }}" style="font-size: 0.8rem; table-layout: fixed;">
        <thead class="table-light">
            <tr>
                <th scope="col" class="ps-4" style="width: 250px; min-width: 250px; white-space: nowrap;">Asset Class</th>
                {% for at in account_types %}
                    <th scope="col" class="text-center" colspan="3">{{ at.label }}</th>
                {% endfor %}
                <th scope="col" class="text-center table-active" colspan="3">Total Portfolio ({% if mode == 'percent' %}%{% else %}${% endif %})</th>
            </tr>
            <tr>
                <th></th>
                {% for at in account_types %}
                    <th scope="col" class="text-center small text-muted">Actual</th>
                    <th scope="col" class="text-center small text-muted col-mode-policy d-none">Policy</th>
                    <th scope="col" class="text-center small text-muted col-mode-effective">Effective</th>
                    <th scope="col" class="text-center small text-muted">Variance</th>
                {% endfor %}
                <th scope="col" class="text-center small table-active text-muted">Actual</th>
                <th scope="col" class="text-center small table-active text-muted col-mode-policy d-none">Policy</th>
                <th scope="col" class="text-center small table-active text-muted col-mode-effective">Effective</th>
                <th scope="col" class="text-center small table-active text-muted">Variance</th>
            </tr>
        </thead>
        <tbody>
            {% for row in rows %}
            <tr class="{{ row.row_type|row_css_class }}">
                <td class="ps-4">{{ row.asset_class_name }}</td>
                {% for at_col in row.account_types %}
                    <td class="text-end pe-1 small {% if row.is_grand_total %}text-white{% elif row.is_subtotal or row.is_group_total %}text-dark{% else %}text-muted{% endif %}">{{ at_col.actual|safe }}</td>
                    <td class="text-end pe-1 small col-mode-policy d-none {% if row.is_grand_total %}text-white{% endif %}">{{ at_col.policy|safe }}</td>
                    <td class="text-end pe-1 small col-mode-effective {% if row.is_grand_total %}text-white{% endif %}">{{ at_col.effective|safe }}</td>
                    <td class="text-end pe-1 small fw-bold variance-col {{ at_col.effective_variance_raw|variance_css_class }} {% if row.is_grand_total %}text-white{% endif %}"
                        data-effective-variance="{{ at_col.effective_variance|safe }}"
                        data-policy-variance="{{ at_col.policy_variance|safe }}">
                        <span class="variance-value">{{ at_col.effective_variance|safe }}</span>
                    </td>
                {% endfor %}
                <td class="text-end pe-2 table-active {% if row.is_grand_total %}text-white{% elif row.is_subtotal or row.is_group_total %}text-dark{% else %}text-muted{% endif %}">{{ row.portfolio.actual|safe }}</td>
                <td class="text-end pe-2 table-active col-mode-policy d-none {% if row.is_grand_total %}text-white{% endif %}">{{ row.portfolio.explicit_target|safe }}</td>
                <td class="text-end pe-2 table-active col-mode-effective {% if row.is_grand_total %}text-white{% endif %}">{{ row.portfolio.effective|safe }}</td>
                <td class="text-end pe-2 table-active fw-bold variance-col {{ row.portfolio.effective_variance_raw|variance_css_class }} {% if row.is_grand_total %}text-white{% endif %}"
                    data-effective-variance="{{ row.portfolio.effective_variance|safe }}"
                    data-policy-variance="{{ row.portfolio.effective_variance|safe }}"> <!-- Portfolio only has effective variance currently, or we might need to clarify if it has policy variance -->
                    <span class="variance-value">{{ row.portfolio.effective_variance|safe }}</span>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endwith %}
{% else %}
    <p class="text-muted">No holdings data available.</p>
{% endif %}
