{% extends "portfolio/base.html" %}

{% block title %}New Allocation Strategy | CB3 Portfolio{% endblock %}

{% block content %}
<div class="row">
    <!-- Sidebar Column -->
    <div id="sidebar-column" class="col-md-2 d-none d-md-block px-0">
        {% include "portfolio/sidebar.html" %}
    </div>

    <div id="main-content-column" class="col-md-10">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h2 mb-0">New Allocation Strategy</h1>
                <p class="text-muted mt-2">
                    Define a reusable target allocation strategy.
                </p>
            </div>
            <div>
                 <a href="{% url 'portfolio:target_allocations' %}" class="btn btn-outline-secondary me-2">Cancel</a>
                 <button type="submit" form="strategy-form" class="btn btn-primary">Create Strategy</button>
            </div>
        </div>

        <form method="post" id="strategy-form">
            {% csrf_token %}
            
            {% if form.non_field_errors %}
            <div class="alert alert-danger">
                {{ form.non_field_errors }}
            </div>
            {% endif %}

            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">Strategy Details</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="{{ form.name.id_for_label }}" class="form-label">Strategy Name</label>
                        {{ form.name }}
                        {% if form.name.errors %}
                            <div class="text-danger small">{{ form.name.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="mb-3">
                        <label for="{{ form.description.id_for_label }}" class="form-label">Description (Optional)</label>
                        {{ form.description }}
                        {% if form.description.errors %}
                            <div class="text-danger small">{{ form.description.errors }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">Asset Allocation Targets</h5>
                </div>
                <div class="card-body p-0">
                    <div class="alert alert-info m-3">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Note:</strong> Cash allocation will be calculated automatically 
                        as the remainder (100% minus the sum of all other allocations).
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Asset Class</th>
                                    <th style="width: 200px;">Target %</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for category, fields in form.get_grouped_fields %}
                                    <tr class="table-secondary">
                                        <td colspan="2" class="fw-bold text-uppercase small px-3 py-2">{{ category }}</td>
                                    </tr>
                                    {% for field in fields %}
                                    <tr>
                                        <td class="ps-4">
                                            <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                                            <div class="small text-muted">{{ field.help_text }}</div>
                                        </td>
                                        <td>
                                            <div class="input-group">
                                                {{ field }}
                                                <span class="input-group-text">%</span>
                                            </div>
                                            {% if field.errors %}
                                                <div class="text-danger small">{{ field.errors }}</div>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr class="table-secondary">
                                    <td class="fw-bold text-end">Total Allocation:</td>
                                    <td class="fw-bold">
                                        <span id="total-allocation">0.00</span>%
                                    </td>
                                </tr>
                                <tr class="table-light">
                                    <td class="fw-bold text-end">Cash (Calculated):</td>
                                    <td class="fw-bold">
                                        <span id="cash-preview">0.00</span>%
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <div class="mt-4 text-end">
                <button type="submit" class="btn btn-primary">Create Strategy</button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const inputs = document.querySelectorAll('input[name^="target_"]');
    const totalDisplay = document.getElementById('total-allocation');

    function updateTotal() {
        let total = 0;
        inputs.forEach(input => {
            const val = parseFloat(input.value) || 0;
            total += val;
        });
        totalDisplay.textContent = total.toFixed(2);
        
        const cash = Math.max(0, 100 - total);
        const cashPreview = document.getElementById('cash-preview');
        cashPreview.textContent = cash.toFixed(2);

        if (total > 100) {
            totalDisplay.classList.add('text-danger');
            cashPreview.classList.add('text-danger');
            cashPreview.textContent = "0.00 (Total > 100%)";
        } else {
            totalDisplay.classList.remove('text-danger');
            cashPreview.classList.remove('text-danger');
        }
    }

    inputs.forEach(input => {
        input.addEventListener('input', updateTotal);
    });

    // Initial calculation
    updateTotal();
});
</script>
{% endblock %}
