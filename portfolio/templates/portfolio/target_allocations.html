{% extends "portfolio/base.html" %}

{% block title %}Target Allocations | CB3 Portfolio{% endblock %}

{% block content %}
<div class="row">
    <!-- Sidebar Column -->
    <div id="sidebar-column" class="col-md-2 d-none d-md-block px-0">
        {% include "portfolio/sidebar.html" %}
    </div>

    <div id="main-content-column" class="col-md-10">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h2 mb-0">Target Allocations</h1>
                <p class="text-muted mt-2">
                    Set default target allocations for each account type.
                    Expand columns to override for specific accounts.
                    <br>
                    <small>Aggregate targets are calculated bottom-up based on account values.</small>
                </p>
            </div>
            <div class="d-flex align-items-center gap-3">
                 <!-- Variance Mode Toggle -->
                 <div class="btn-group" role="group" aria-label="Variance display mode">
                    <input type="radio" class="btn-check" name="variance-mode" id="variance-effective" value="effective" checked autocomplete="off">
                    <label class="btn btn-outline-primary" for="variance-effective" title="Show variance from weighted average target (for rebalancing)">
                        <i class="bi bi-graph-up"></i> Effective Variance
                    </label>

                    <input type="radio" class="btn-check" name="variance-mode" id="variance-policy" value="policy" autocomplete="off">
                    <label class="btn btn-outline-primary" for="variance-policy" title="Show variance from stated strategy (for policy adherence)">
                        <i class="bi bi-clipboard-check"></i> Policy Variance
                    </label>
                </div>

                 <a href="{% url 'portfolio:dashboard' %}" class="btn btn-outline-secondary">Cancel</a>
                 <button type="submit" form="allocation-form" id="save-button-top" class="btn btn-primary">Save Targets</button>
            </div>
        </div>

        <!-- Info alert explaining variance modes -->
        <div class="alert alert-info alert-dismissible fade show" role="alert" id="variance-info">
            <strong><i class="bi bi-info-circle"></i> Variance Modes:</strong>
            <ul class="mb-0 mt-2">
                <li><strong>Effective Variance</strong> (default) - Shows how far you are from your <em>achievable</em> target given your account balances. Use this for <strong>rebalancing decisions</strong>.</li>
                <li><strong>Policy Variance</strong> - Shows how far you are from your <em>stated strategy</em>. Use this to <strong>monitor strategy adherence</strong>.</li>
            </ul>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>

        <form method="post" id="allocation-form">
            {% csrf_token %}
            <div class="card shadow-sm">
                <div class="card-body p-0">
                    <div class="table-responsive">
                       {% include "portfolio/includes/target_allocation_table.html" with rows=allocation_rows_percent mode="percent" table_id="allocations-table" strategies=strategies %}
                    </div>
                </div>
            </div>

            <div class="mt-4 mb-3">
                <h3 class="h4">Target Values ($)</h3>
                <p class="text-muted small">Estimated target dollar values based on current portfolio size.</p>
            </div>

            <div class="card shadow-sm mb-4">
                <div class="card-body p-0">
                    <div class="table-responsive">
                         <!-- DOLLAR TABLE -->
                        {% include "portfolio/includes/target_allocation_table.html" with rows=allocation_rows_money mode="dollar" table_id="allocations-table-money" strategies=strategies %}
                    </div>
                </div>
            </div>

            <div class="mt-3 text-end">
                <button type="submit" id="save-button-bottom" class="btn btn-primary">Save Targets</button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const expandBtns = document.querySelectorAll('.expand-btn');

    // Initial Toggle State (Sync both tables)
    expandBtns.forEach(btn => {
        btn.addEventListener('click', () => {
             const atId = btn.dataset.atId;
             const cols = document.querySelectorAll(`.col-acc-${atId}`);
             let isHidden = true;
             cols.forEach(col => {
                 if (col.classList.contains('d-none')) {
                     col.classList.remove('d-none');
                     isHidden = false;
                 } else {
                     col.classList.add('d-none');
                     isHidden = true;
                 }
             });
             btn.textContent = isHidden ? '[+]' : '[-]';
        });
    });

    // Variance toggle functionality
    const varianceModeInputs = document.querySelectorAll('input[name="variance-mode"]');

    /**
     * Update variance display based on selected mode
     * @param {string} mode - Either 'effective' or 'policy'
     */
    function updateVarianceDisplay(mode) {
        // 1. Toggle Variance Values
        const varianceCells = document.querySelectorAll('.variance-col');
        varianceCells.forEach(cell => {
            const valueSpan = cell.querySelector('.variance-value');
            if (!valueSpan) return;

            if (mode === 'effective') {
                // Show effective variance
                const effectiveVar = cell.dataset.effectiveVariance;
                if (effectiveVar) {
                    valueSpan.textContent = effectiveVar;
                }
            } else {
                // Show policy variance (if it exists)
                const policyVar = cell.dataset.policyVariance;
                if (policyVar) {
                    valueSpan.textContent = policyVar;
                } else {
                    // Portfolio level doesn't have policy variance, keep effective
                    valueSpan.textContent = cell.dataset.effectiveVariance || '';
                }
            }
        });

        // 2. Toggle Allocation Columns (Policy vs Effective)
        const policyCols = document.querySelectorAll('.col-mode-policy');
        const effectiveCols = document.querySelectorAll('.col-mode-effective');

        if (mode === 'effective') {
            policyCols.forEach(el => el.classList.add('d-none'));
            effectiveCols.forEach(el => el.classList.remove('d-none'));
        } else {
            policyCols.forEach(el => el.classList.remove('d-none'));
            effectiveCols.forEach(el => el.classList.add('d-none'));
        }

        // Store preference in localStorage for persistence
        localStorage.setItem('varianceMode', mode);
    }

    // Add event listeners to radio buttons
    varianceModeInputs.forEach(input => {
        input.addEventListener('change', function() {
            if (this.checked) {
                updateVarianceDisplay(this.value);

                // Flash the variance columns briefly to indicate change
                const varianceCells = document.querySelectorAll('.variance-col');
                varianceCells.forEach(cell => {
                    cell.style.transition = 'background-color 0.3s ease';
                    cell.style.backgroundColor = '#fff3cd';
                    setTimeout(() => {
                        cell.style.backgroundColor = '';
                    }, 300);
                });
            }
        });
    });

    // Restore saved preference or default to 'effective'
    const savedMode = localStorage.getItem('varianceMode') || 'effective';
    const savedInput = document.getElementById(`variance-${savedMode}`);
    if (savedInput) {
        savedInput.checked = true;
        updateVarianceDisplay(savedMode);
    }
});
</script>

{# These may be needed for future HTMX integration #}
{# {{ at_values|json_script:"at-values-json" }} #}
{# {{ account_totals|json_script:"account-totals-json" }} #}
{# {{ portfolio_total_value|json_script:"portfolio-total-value-json" }} #}
{% endblock %}
