{% extends "portfolio/base.html" %}
{% load portfolio_extras %}

{% block title %}Target Allocations | CB3 Portfolio{% endblock %}

{% block content %}
<div class="row">
    <!-- Sidebar Column -->
    <div class="col-md-2 d-none d-md-block px-0">
        {% include "portfolio/sidebar.html" %}
    </div>

    <div class="col-md-10">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h2 mb-0">Target Allocations</h1>
                <p class="text-muted mt-2">
                    Set default target allocations for each account type. 
                    Expand columns to override for specific accounts.
                    <br>
                    <small>Aggregate targets are calculated bottom-up based on account values.</small>
                </p>
            </div>
            <div>
                 <a href="{% url 'portfolio:dashboard' %}" class="btn btn-outline-secondary me-2">Cancel</a>
                 <button type="submit" form="allocation-form" id="save-button-top" class="btn btn-primary">Save Targets</button>
            </div>
        </div>

        <form method="post" id="allocation-form">
            {% csrf_token %}
            <div class="card shadow-sm">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-bordered table-striped table-hover mb-0 align-middle" id="allocations-table">
                            <thead class="table-light">
                                <tr>
                                    <th scope="col" class="ps-4" rowspan="2" style="min-width: 200px;">Asset Class</th>
                                    {% for at in account_types %}
                                        <!-- Account Type Header -->
                                        <th scope="col" class="text-center border-bottom-0 position-relative" colspan="4">
                                            {{ at.label }}
                                            {% if at.active_accounts %}
                                            <button type="button" class="btn btn-sm btn-link p-0 ms-2 text-decoration-none expand-btn" 
                                                    data-at-id="{{ at.id }}" title="Show/Hide Individual Accounts">
                                                [+]
                                            </button>
                                            {% endif %}
                                        </th>
                                        <!-- Individual Accounts Headers -->
                                        {% for acc in at.active_accounts %}
                                            <th scope="col" class="text-center border-bottom-0 table-warning d-none col-acc-{{ at.id }}" colspan="3">
                                                <small>{{ acc.name }}</small>
                                            </th>
                                        {% endfor %}
                                    {% endfor %}
                                    <th scope="col" class="text-center table-active border-bottom-0" colspan="3">Total Portfolio (%)</th>
                                </tr>
                                <tr>
                                    {% for at in account_types %}
                                        <!-- Account Type Sub-headers -->
                                        <th scope="col" class="text-center small border-top-0 text-muted" style="min-width: 50px;">Current</th>
                                        <th scope="col" class="text-center small border-top-0 text-muted" style="min-width: 90px;">Target</th>
                                        <th scope="col" class="text-center small border-top-0 text-muted" style="min-width: 60px;">Wt. Target</th>
                                        <th scope="col" class="text-center small border-top-0 text-muted" style="min-width: 50px;">Variance</th>
                                        
                                        <!-- Individual Accounts Sub-headers -->
                                        {% for acc in at.active_accounts %}
                                            <th scope="col" class="text-center small border-top-0 text-muted table-warning d-none col-acc-{{ at.id }}" style="min-width: 50px;">Curr</th>
                                            <th scope="col" class="text-center small border-top-0 text-muted table-warning d-none col-acc-{{ at.id }}" style="min-width: 80px;">Override</th>
                                            <th scope="col" class="text-center small border-top-0 text-muted table-warning d-none col-acc-{{ at.id }}" style="min-width: 50px;">Eff</th>
                                        {% endfor %}
                                    {% endfor %}
                                    
                                    <th scope="col" class="text-center small table-active border-top-0 text-muted">Curr</th>
                                    <th scope="col" class="text-center small table-active border-top-0 text-muted">Target</th>
                                    <th scope="col" class="text-center small table-active border-top-0 text-muted">Var</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for group, categories in hierarchical_data %}
                                    <!-- Groups -->
                                    {% for cat_info, assets in categories %}
                                         <!-- Assets -->
                                         {% for ac in assets %}
                                            <tr data-ac-id="{{ ac.id }}" data-category-code="{{ cat_info.obj.code }}">
                                                <td class="ps-4">{{ ac.name }}</td>
                                                {% for at in account_types %}
                                                    <!-- 1. Account Type Columns -->
                                                    <!-- Current -->
                                                    <td class="text-end pe-1 text-muted small" 
                                                        data-at-current="{{ at.allocation_map|get_item:ac.id|default:0 }}">
                                                        {{ at.allocation_map|get_item:ac.id|default:0|accounting_percent:1 }}
                                                    </td>

                                                    <!-- Default Input -->
                                                    <td class="p-1">
                                                        <div class="input-group input-group-sm">
                                                            <input type="number" 
                                                                   name="target_{{ at.id }}_{{ ac.id }}" 
                                                                   step="0.01" 
                                                                   min="0" 
                                                                   max="100" 
                                                                   class="form-control form-control-sm text-end default-input px-1"
                                                                   data-at-id="{{ at.id }}"
                                                                   data-ac-id="{{ ac.id }}"
                                                                   value="{{ at.target_map|get_item:ac.id|default:'' }}"
                                                                   placeholder="--">
                                                        </div>
                                                    </td>
                                                    
                                                    <!-- Aggregated % -->
                                                    <td class="text-end pe-1 small fw-bold text-muted d-none d-md-table-cell agg-cell">
                                                        <span id="agg-{{ at.id }}-{{ ac.id }}">--</span>
                                                    </td>

                                                    <!-- Variance -->
                                                    <td class="text-end pe-1 small fw-bold">
                                                        <span id="var-{{ at.id }}-{{ ac.id }}">--</span>
                                                    </td>
                                                    
                                                    <!-- Individual Accounts -->
                                                    {% for acc in at.active_accounts %}
                                                        <!-- Current -->
                                                        <td class="text-end pe-1 text-muted small table-warning d-none col-acc-{{ at.id }}">
                                                             {{ acc.allocation_map|get_item:ac.id|default:0|accounting_percent:1 }}
                                                        </td>
                                                        <!-- Override Input -->
                                                        <td class="p-1 table-warning d-none col-acc-{{ at.id }}">
                                                            <input type="number"
                                                                   name="target_account_{{ acc.id }}_{{ ac.id }}"
                                                                   step="0.01"
                                                                   min="0"
                                                                   max="100"
                                                                   class="form-control form-control-sm text-end override-input px-1"
                                                                   data-acc-id="{{ acc.id }}"
                                                                   data-at-id="{{ at.id }}"
                                                                   data-ac-id="{{ ac.id }}"
                                                                   value="{{ acc.target_map|get_item:ac.id|default:'' }}"
                                                                   placeholder="--">
                                                        </td>
                                                        <!-- Effective % -->
                                                        <td class="text-end pe-2 small table-warning d-none col-acc-{{ at.id }}">
                                                            <span id="eff-{{ acc.id }}-{{ ac.id }}" class="text-muted">--</span>
                                                        </td>
                                                    {% endfor %}
                                                {% endfor %}
                                                
                                                <!-- PORTFOLIO TOTALS -->
                                                <td class="text-end pe-2 table-active text-muted">
                                                    <!-- Calc explicit pct of total -->
                                                    {{ ac.current_total_value|percentage_of:portfolio_total_value|accounting_percent:1 }}
                                                </td>
                                                <td class="text-end pe-2 table-active">
                                                    <span id="row-total-{{ ac.id }}">0.00%</span>
                                                </td>
                                                <td class="text-end pe-2 table-active fw-bold">
                                                    <span id="row-var-{{ ac.id }}">0.00%</span>
                                                </td>
                                            </tr>
                                        {% endfor %}

                                        <!-- Subtotal Row for Category -->
                                        <tr class="table-info fw-bold category-subtotal-{{ cat_info.obj.code }}">
                                            <td class="ps-4 text-dark">{{ cat_info.obj.label }} Total</td>
                                            {% for at in account_types %}
                                                <!-- Account Type Subtotals -->
                                                <td class="text-end pe-1 small text-dark">
                                                    <span id="sub-curr-{{ at.id }}-{{ cat_info.obj.code }}">
                                                        {{ cat_info.allocation_map|get_item:at.id|default:0|accounting_percent:1 }}
                                                    </span>
                                                </td>
                                                <td class="text-end pe-1 small text-dark">
                                                     <!-- Default Target Sum (JS will update) -->
                                                     <span id="sub-def-{{ at.id }}-{{ cat_info.obj.code }}">--</span>
                                                </td>
                                                <td class="text-end pe-1 small text-dark d-none d-md-table-cell">
                                                     <!-- Aggregated Target Sum (JS will update) -->
                                                     <span id="sub-agg-{{ at.id }}-{{ cat_info.obj.code }}">--</span>
                                                </td>
                                                <td class="text-end pe-1 small text-dark">
                                                     <!-- Variance Sum (JS will update) -->
                                                     <span id="sub-var-{{ at.id }}-{{ cat_info.obj.code }}">--</span>
                                                </td>
                                                
                                                <!-- Individual Accounts Subtotals -->
                                                {% for acc in at.active_accounts %}
                                                    <td class="text-end pe-1 small table-warning d-none col-acc-{{ at.id }} text-dark">
                                                        {{ cat_info.account_allocation_map|get_item:acc.id|default:0|accounting_percent:1 }}
                                                    </td>
                                                    <td class="text-end pe-1 small table-warning d-none col-acc-{{ at.id }} text-dark">
                                                         <!-- Override Target Sum (JS) -->
                                                         <span id="sub-over-{{ acc.id }}-{{ cat_info.obj.code }}">--</span>
                                                    </td>
                                                    <td class="text-end pe-2 small table-warning d-none col-acc-{{ at.id }} text-dark">
                                                         <!-- Effective Target Sum (JS) -->
                                                         <span id="sub-eff-{{ acc.id }}-{{ cat_info.obj.code }}">--</span>
                                                    </td>
                                                {% endfor %}
                                            {% endfor %}
                                            
                                            <!-- Portfolio Totals Subtotal -->
                                            <td class="text-end pe-2 table-active text-dark">
                                                <span id="sub-total-curr-{{ cat_info.obj.code }}">{{ cat_info.total_value|percentage_of:portfolio_total_value|accounting_percent:1 }}</span>
                                            </td>
                                            <td class="text-end pe-2 table-active text-dark">
                                                <span id="sub-total-target-{{ cat_info.obj.code }}">--</span>
                                            </td>
                                            <td class="text-end pe-2 table-active text-dark">
                                                <span id="sub-total-var-{{ cat_info.obj.code }}">--</span>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                {% endfor %}
                                
                                <!-- Implicit Cash Row -->
                                <tr class="table-warning fw-bold border-top-2" data-ac-id="cash">
                                    <td class="ps-4">Cash (Calculated)</td>
                                    {% for at in account_types %}
                                        <!-- Default Residual -->
                                        <td class="text-end pe-2 text-muted small"
                                            data-at-current="{{ at.allocation_map|get_item:cash_asset_class_id|default:0 }}">
                                            {{ at.allocation_map|get_item:cash_asset_class_id|default:0|accounting_percent:1 }}
                                        </td>
                                        <td class="text-end pe-2">
                                            <span id="cash-default-{{ at.id }}">100%</span>
                                        </td>
                                        <!-- Aggregated -->
                                        <td class="text-end pe-2">
                                            <span id="cash-agg-{{ at.id }}">0.0%</span>
                                        </td>
                                        <td class="text-end pe-2">
                                            <span id="cash-var-{{ at.id }}">0.0%</span>
                                        </td>
                                        
                                        {% for acc in at.active_accounts %}
                                            <!-- CASH: Current (Calculated from Holdings) -->
                                            <td class="text-end pe-2 d-none col-acc-{{ at.id }} text-muted small table-warning">
                                                 {{ acc.allocation_map|get_item:cash_asset_class_id|default:0|accounting_percent:1 }}
                                            </td>
                                            
                                            <!-- CASH: Override Input -->
                                            <td class="p-1 table-warning d-none col-acc-{{ at.id }}">
                                                 <input type="number"
                                                       name="target_account_{{ acc.id }}_{{ cash_asset_class_id }}"
                                                       step="0.01"
                                                       min="0"
                                                       max="100"
                                                       class="form-control form-control-sm text-end override-input px-1"
                                                       data-acc-id="{{ acc.id }}"
                                                       data-at-id="{{ at.id }}"
                                                       data-ac-id="cash"
                                                       value="{{ acc.target_map|get_item:cash_asset_class_id|default:'' }}"
                                                       placeholder="--">
                                            </td>

                                            <!-- CASH: Effective (Calculated or Override) -->
                                            <td class="text-end pe-2 d-none col-acc-{{ at.id }} table-warning">
                                                <span id="cash-eff-{{ acc.id }}">100%</span>
                                            </td>
                                        {% endfor %}
                                    {% endfor %}
                                    
                                    <td class="text-end pe-2 table-active">
                                        <span id="cash-current">--</span>
                                    </td>
                                    <td class="text-end pe-2 table-active">
                                        <span id="cash-total">0.00%</span>
                                    </td>
                                    <td class="text-end pe-2 table-active">
                                         <span id="cash-var">0.00%</span>
                                    </td>
                                </tr>

                                <!-- Total Row -->
                                <tr class="table-light border-top fw-bold">
                                    <td class="ps-4">Total</td>
                                    {% for at in account_types %}
                                        <td class="text-end pe-2">100%</td>
                                        <td class="text-end pe-2">
                                            <span id="total-default-{{ at.id }}" class="total-display">0.00%</span>
                                        </td>
                                        <td class="text-end pe-2">
                                            <span id="total-agg-{{ at.id }}">0.00%</span>
                                        </td>
                                        <td class="text-end pe-2">
                                            <span id="total-var-{{ at.id }}">0.00%</span>
                                        </td>
                                        {% for acc in at.active_accounts %}
                                            <td class="d-none col-acc-{{ at.id }}"></td>
                                            <td class="text-end pe-2 d-none col-acc-{{ at.id }}">
                                                 <span id="total-eff-{{ acc.id }}">100%</span>
                                            </td>
                                            <td class="d-none col-acc-{{ at.id }}"></td>
                                        {% endfor %}
                                    {% endfor %}
                                    
                                    <td class="text-end pe-2 table-active">100.0%</td>
                                    <td class="text-end pe-2 table-active">100.0%</td>
                                    <td class="text-end pe-2 table-active">0.0%</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="mt-3 text-end">
                <button type="submit" id="save-button-bottom" class="btn btn-primary">Save Targets</button>
            </div>
        </form>
    </div>
</div>

<!-- Data for JS -->
<script id="account-data" type="application/json">
{
    "account_values": {
        {% for at in account_types %}
            {% for acc in at.active_accounts %}
                "{{ acc.id }}": {{ acc.current_total_value|default:0 }},
            {% endfor %}
        {% endfor %}
        "null": 0 
    },
    "portfolio_total": {{ portfolio_total_value|default:0 }}
}
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const defaultInputs = document.querySelectorAll('.default-input');
    const overrideInputs = document.querySelectorAll('.override-input');
    const allInputs = [...defaultInputs, ...overrideInputs];
    const saveButtons = [document.getElementById('save-button-top'), document.getElementById('save-button-bottom')];
    const expandBtns = document.querySelectorAll('.expand-btn');
    
    // Parse Data
    const dataObj = JSON.parse(document.getElementById('account-data').textContent.replace(/,\s*}/, '}')); // remove trailing comma hack if needed
    const accountValues = dataObj.account_values;
    const portfolioTotal = parseFloat(dataObj.portfolio_total);

    // Initial Toggle State
    expandBtns.forEach(btn => {
        btn.addEventListener('click', () => {
             const atId = btn.dataset.atId;
             const cols = document.querySelectorAll(`.col-acc-${atId}`);
             let isHidden = true;
             cols.forEach(col => {
                 if (col.classList.contains('d-none')) {
                     col.classList.remove('d-none');
                     isHidden = false;
                 } else {
                     col.classList.add('d-none');
                     isHidden = true;
                 }
             });
             btn.textContent = isHidden ? '[+]' : '[-]';
        });
    });

    function formatPct(val) {
        return val.toFixed(1) + '%';
    }
    
    // Core Calculation Logic
    function updateCalculations() {
        let valid = true;
        
        // 1. Gather Defaults: {atId: {acId: val}}
        const defaults = {};
        const defaultTotals = {}; // atId -> total
        
        defaultInputs.forEach(inp => {
            const atId = inp.dataset.atId;
            const acId = inp.dataset.acId;
            const val = parseFloat(inp.value) || 0;
            
            if (!defaults[atId]) defaults[atId] = {};
            defaults[atId][acId] = val;
            
            if (!defaultTotals[atId]) defaultTotals[atId] = 0;
            defaultTotals[atId] += val;
        });
        
        // 2. Gather Overrides: {accId: {acId: val}}
        const overrides = {};
        overrideInputs.forEach(inp => {
            const accId = inp.dataset.accId;
            const acId = inp.dataset.acId;
            const valStr = inp.value.trim();
            
            if (valStr !== '') {
                 if (!overrides[accId]) overrides[accId] = {};
                 overrides[accId][acId] = parseFloat(valStr);
            }
        });
        
        // 3. Compute Effective Targets & Aggregate
        const assetRows = document.querySelectorAll('tr[data-ac-id]');
        const aggTargetDollars = {}; // acId -> dollars
        const atTargetDollars = {}; // atId -> {acId: dollars}
        const atTotalDollars = {}; // atId -> total target dollars
        
        const accountEffectiveCash = {}; // accId -> val
        const atEffectiveCashDollars = {}; // atId -> dollars
        
        // Initialize aggregation buckets
        assetRows.forEach(row => {
             const acId = row.dataset.acId;
             if(acId !== 'cash') {
                 aggTargetDollars[acId] = 0;
             }
        });
        
        const accountIds = new Set();
        overrideInputs.forEach(inp => accountIds.add(inp.dataset.accId));
        const accountAtMap = {};
        overrideInputs.forEach(inp => accountAtMap[inp.dataset.accId] = inp.dataset.atId);
        
        // Compute Effective for each Account
        for (const accId of accountIds) {
            const atId = accountAtMap[accId];
            const accValue = accountValues[accId] || 0;
            const accDefaults = defaults[atId] || {};
            const accOverrides = overrides[accId] || {};
            
            const hasOverrides = Object.keys(accOverrides).length > 0;
            
            let accTotalEffectiveNonCash = 0;
            
            // Process Standard Asset Classes
            assetRows.forEach(row => {
                const acId = row.dataset.acId;
                if(acId === 'cash') return;
                
                let effective = 0;
                if (hasOverrides) {
                    effective = accOverrides[acId] || 0;
                } else {
                    effective = accDefaults[acId] || 0;
                }
                
                accTotalEffectiveNonCash += effective;
                
                // Update UI for Account Effective
                const effSpan = document.getElementById(`eff-${accId}-${acId}`);
                if(effSpan) { 
                    effSpan.textContent = formatPct(effective); 
                    if(hasOverrides && accOverrides.hasOwnProperty(acId)) {
                        effSpan.classList.add('fw-bold'); // Explicit
                    } else {
                        effSpan.classList.remove('fw-bold');
                    }
                }
                
                // Aggregate Dollars
                const dollars = accValue * (effective / 100);
                
                if (!atTargetDollars[atId]) atTargetDollars[atId] = {};
                if (!atTargetDollars[atId][acId]) atTargetDollars[atId][acId] = 0;
                atTargetDollars[atId][acId] += dollars;
                
                if (!aggTargetDollars[acId]) aggTargetDollars[acId] = 0;
                aggTargetDollars[acId] += dollars;
            });
            
            // Process Cash
            let cashEff = 0;
            if (hasOverrides) {
                 if (accOverrides['cash'] !== undefined) {
                      cashEff = accOverrides['cash'];
                 } else {
                      cashEff = Math.max(0, 100 - accTotalEffectiveNonCash);
                 }
            } else {
                 const defTotal = defaultTotals[atId] || 0;
                 cashEff = Math.max(0, 100 - defTotal);
            }
            
            const cashSpan = document.getElementById(`cash-eff-${accId}`);
            if(cashSpan) {
                cashSpan.textContent = formatPct(cashEff);
                if (hasOverrides && accOverrides['cash'] !== undefined) {
                     cashSpan.classList.add('fw-bold', 'text-primary'); 
                } else {
                     cashSpan.classList.remove('fw-bold', 'text-primary');
                }
                
                const totalAlloc = accTotalEffectiveNonCash + cashEff;
                if (Math.abs(totalAlloc - 100) > 0.1) {
                     cashSpan.classList.add('text-danger');
                } else {
                     cashSpan.classList.remove('text-danger');
                }
            }
            
            const cashDollars = accValue * (cashEff/100);
            if (!atEffectiveCashDollars[atId]) atEffectiveCashDollars[atId] = 0;
            atEffectiveCashDollars[atId] += cashDollars;
            
            // Total Row for Account
            const totSpan = document.getElementById(`total-eff-${accId}`);
            if(totSpan) totSpan.textContent = formatPct(accTotalEffectiveNonCash + cashEff);
        }
        
        // 4. Update Aggregates in UI
        
        // Account Type Defaults
        for (const [atId, total] of Object.entries(defaultTotals)) {
             const cashDef = Math.max(0, 100 - total);
             const cashEl = document.getElementById(`cash-default-${atId}`);
             if(cashEl) cashEl.textContent = formatPct(cashDef);
             
             const totEl = document.getElementById(`total-default-${atId}`);
             if(totEl) totEl.textContent = formatPct(total + cashDef);
             
             if (total > 100.01) valid = false;
        }
        
        // Prepare Helper for AT Totals
        const atTotalValues = {};
        for(const [accId, atId] of Object.entries(accountAtMap)) {
            if(!atTotalValues[atId]) atTotalValues[atId] = 0;
            atTotalValues[atId] += (accountValues[accId] || 0);
        }
        
        // Track Category Totals
        const categoryTargets = {}; // catCode -> dollars
        const atCategoryTargets = {}; // atId -> { catCode: dollars }
        const atCategoryDefaults = {}; // atId -> { catCode: val }
        
        // Standard Assets Rows Update
        assetRows.forEach(row => {
             const acId = row.dataset.acId;
             const catCode = row.dataset.categoryCode;
             
             if(acId === 'cash') return;
             
             // 4a. Update Account Type Columns
             for (const [atId, dollarsMap] of Object.entries(atTargetDollars)) {
                  const dollars = dollarsMap[acId] || 0;
                  const totalVal = atTotalValues[atId] || 0;
                  const pct = totalVal > 0 ? (dollars / totalVal * 100) : 0;
                  
                  const el = document.getElementById(`agg-${atId}-${acId}`);
                  if(el) el.textContent = formatPct(pct);

                  // Update Variance (Current - Wt. Target)
                  // Find Current Cell
                  const aggCell = el ? el.parentElement : null;
                  if (aggCell) {
                      const targetCell = aggCell.previousElementSibling;
                      const currCell = targetCell ? targetCell.previousElementSibling : null;
                      
                      if (currCell && currCell.dataset.atCurrent) {
                           const currentVal = parseFloat(currCell.dataset.atCurrent.replace(/[^0-9.-]/g, '')) || 0;
                           const variance = currentVal - pct;
                           
                           const varEl = document.getElementById(`var-${atId}-${acId}`);
                           if (varEl) {
                               varEl.textContent = formatPct(variance);
                               varEl.classList.remove('text-success', 'text-danger', 'text-muted');
                               if (variance > 0.05) varEl.classList.add('text-success');
                               else if (variance < -0.05) varEl.classList.add('text-danger');
                               else varEl.classList.add('text-muted');
                           }
                      }
                  }
                  
                  // Accumulate for Category Subtotals
                  if (catCode) {
                      if (!atCategoryTargets[atId]) atCategoryTargets[atId] = {};
                      if (!atCategoryTargets[atId][catCode]) atCategoryTargets[atId][catCode] = 0;
                      atCategoryTargets[atId][catCode] += dollars;
                      
                      const defVal = (defaults[atId] && defaults[atId][acId]) ? defaults[atId][acId] : 0;
                      if (!atCategoryDefaults[atId]) atCategoryDefaults[atId] = {};
                      if (!atCategoryDefaults[atId][catCode]) atCategoryDefaults[atId][catCode] = 0;
                      atCategoryDefaults[atId][catCode] += defVal;
                  }
             }
             
             // 4b. Update Portfolio Total Columns
             const totalDollars = aggTargetDollars[acId] || 0;
             const portPct = portfolioTotal > 0 ? (totalDollars / portfolioTotal * 100) : 0;
             document.getElementById(`row-total-${acId}`).textContent = formatPct(portPct);
             
             // Accumulate Category Target
             if (catCode) {
                 if (!categoryTargets[catCode]) categoryTargets[catCode] = 0;
                 categoryTargets[catCode] += totalDollars;
             }
             
             // Variance
             // Get Current Pct from DOM (Table-active row)
             const portTotalCell = document.getElementById(`row-total-${acId}`).parentElement;
             const portCurrCell = portTotalCell ? portTotalCell.previousElementSibling : null;
             
             if (portCurrCell) {
                 const currentText = portCurrCell.innerText.replace('%','');
                 const currentPct = parseFloat(currentText) || 0;
                 const variance = currentPct - portPct;
                 
                 const varEl = document.getElementById(`row-var-${acId}`);
                 varEl.textContent = formatPct(variance);
                 
                 // Style
                 varEl.className = 'text-end pe-2 table-active fw-bold ' + (variance >= 0 ? 'text-success' : 'text-danger');
             }
        });
        
        // 5. Update Category Subtotals
        const subtotalRows = document.querySelectorAll('tr[class*="category-subtotal-"]');
        let sumSubtotalCurrents = 0;

        subtotalRows.forEach(row => {
             // Extract category code
             const classes = Array.from(row.classList);
             const subClass = classes.find(c => c.startsWith('category-subtotal-'));
             if(!subClass) return;
             const catCode = subClass.replace('category-subtotal-', '');
             
             // Calculate Total Target
             const catDollars = categoryTargets[catCode] || 0;
             const catTargetPct = portfolioTotal > 0 ? (catDollars / portfolioTotal * 100) : 0;
             
             document.getElementById(`sub-total-target-${catCode}`).textContent = formatPct(catTargetPct);
             
             // Calculate Variance: Current - Target
             const currSpan = document.getElementById(`sub-total-curr-${catCode}`);
             if (currSpan) {
                 const currPct = parseFloat(currSpan.innerText.replace('%','')) || 0;
                 sumSubtotalCurrents += currPct;
                 
                 const variance = currPct - catTargetPct;
                 const varEl = document.getElementById(`sub-total-var-${catCode}`);
                 if (varEl) {
                     varEl.textContent = formatPct(variance);
                     varEl.className = 'text-dark ' + (variance >= 0 ? 'text-success' : 'text-danger'); 
                 }
             }
             
             // Update Account Type Subtotals
             // We iterate over known AT IDs (from defaultTotals keys)
             for (const atId of Object.keys(defaultTotals)) {
                  // 1. Default Sum
                  const defSum = (atCategoryDefaults[atId] && atCategoryDefaults[atId][catCode]) ? atCategoryDefaults[atId][catCode] : 0;
                  const defEl = document.getElementById(`sub-def-${atId}-${catCode}`);
                  if (defEl) defEl.textContent = formatPct(defSum);
                  
                  // 2. Wt Target
                  const targDollars = (atCategoryTargets[atId] && atCategoryTargets[atId][catCode]) ? atCategoryTargets[atId][catCode] : 0;
                  const totalVal = atTotalValues[atId] || 0;
                  const wtPct = totalVal > 0 ? (targDollars / totalVal * 100) : 0;
                  
                  const aggEl = document.getElementById(`sub-agg-${atId}-${catCode}`);
                  if (aggEl) aggEl.textContent = formatPct(wtPct);
                  
                  // 3. Variance
                  const atCurrSpan = document.getElementById(`sub-curr-${atId}-${catCode}`);
                  if (atCurrSpan) {
                       const atCurrPct = parseFloat(atCurrSpan.innerText.replace(/[^0-9.-]/g, '')) || 0;
                       
                       const variance = atCurrPct - wtPct;
                       const varEl = document.getElementById(`sub-var-${atId}-${catCode}`);
                       if (varEl) {
                           varEl.textContent = formatPct(variance);
                           varEl.classList.remove('text-success', 'text-danger', 'text-warning');
                           if (variance > 0.05) varEl.classList.add('text-success');
                           else if (variance < -0.05) varEl.classList.add('text-danger');
                       }
                  }
             }
        });

        
        // 5b. Update Cash Row Totals
        let portCashDollars = 0;
        for (const [atId, dollars] of Object.entries(atEffectiveCashDollars)) {
             portCashDollars += dollars;
             // Update AT columns too
             const totalVal = atTotalValues[atId] || 0;
             const pct = totalVal > 0 ? (dollars / totalVal * 100) : 0;
             const atCashEl = document.getElementById(`cash-agg-${atId}`);
             if(atCashEl) atCashEl.textContent = formatPct(pct);
             
             // Variance for AT
             // Get Current from DOM if available? Or calculate?
             // The template has `data-at-current` on the first cell of cash row (line 220).
             // But the ID for Variance is `cash-var-${atId}`.
             
             // We need to find the Current cell. 
             // Cash row ID="cash-var-${atId}" is in a TD. Parent is TR? No, Parent is TD.
             // Wait, `cash-var` is a span inside a TD.
             // Line 231: <span id="cash-var-...">
             // Line 219: <td data-at-current="...">
             // They are siblings in the same TR loop block.
             // Wait, the loop generates multiple cells.
             
             // We can find the current value by ID? No ID on the `data-at-current` cell.
             // But we can update the template to add ID if we want perfection.
             // Or rely on calculation? 
             // Let's rely on `data-at-current` being on the same row.
             
             const varEl = document.getElementById(`cash-var-${atId}`);
             if (varEl) {
                 // Traverse back to find `data-at-current`
                 // Structure: Default(with data-at-current) | Default Target Span | Agg Span | Var Span
                 // Var Span -> TD -> Prev -> Prev -> Prev (Default TD)
                 
                 const varTd = varEl.parentElement;
                 const aggTd = varTd.previousElementSibling;
                 const defTd = aggTd ? aggTd.previousElementSibling : null;
                 const currTd = defTd ? defTd.previousElementSibling : null;
                 
                 if (currTd && currTd.dataset.atCurrent) {
                      const curVal = parseFloat(currTd.dataset.atCurrent) || 0; 
                      // Note: data-at-current is raw value (dollars or pct?). 
                      // If it's percentage (0-100), fine.
                      // Line 92 used default:0, line 93 formats it. It's likely a number.
                      
                      const variance = curVal - pct;
                      varEl.textContent = formatPct(variance);
                      varEl.classList.remove('text-success', 'text-danger');
                      if (variance > 0.05) varEl.classList.add('text-success');
                      else if (variance < -0.05) varEl.classList.add('text-danger');
                 }
             }
        }
        
        const portCashPct = portfolioTotal > 0 ? (portCashDollars / portfolioTotal * 100) : 0;
        document.getElementById(`cash-total`).textContent = formatPct(portCashPct);
        
        // Cash Current (Calculated)
        const cashCurrentPct = Math.max(0, 100 - sumSubtotalCurrents);
        const cashCurrEl = document.getElementById('cash-current');
        if (cashCurrEl) cashCurrEl.textContent = formatPct(cashCurrentPct);
        
        // Cash Variance
        const cashVar = cashCurrentPct - portCashPct;
        const cashVarEl = document.getElementById('cash-var');
        if (cashVarEl) {
            cashVarEl.textContent = formatPct(cashVar);
            cashVarEl.className = (cashVar >= 0 ? 'text-success' : 'text-danger');
        }

        saveButtons.forEach(btn => btn.disabled = !valid);
    }
    
    allInputs.forEach(inp => inp.addEventListener('input', updateCalculations));
    updateCalculations();
});
</script>
{% endblock %}
