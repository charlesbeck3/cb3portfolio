{% extends "portfolio/base.html" %}

{% block title %}Target Allocations | CB3 Portfolio{% endblock %}

{% block content %}
<div class="row">
    <!-- Sidebar Column -->
    <div class="col-md-2 d-none d-md-block px-0">
        {% include "portfolio/sidebar.html" %}
    </div>

    <div class="col-md-10">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h2 mb-0">Target Allocations</h1>
                <p class="text-muted mt-2">
                    Set default target allocations for each account type. 
                    Expand columns to override for specific accounts.
                    <br>
                    <small>Aggregate targets are calculated bottom-up based on account values.</small>
                </p>
            </div>
            <div>
                 <a href="{% url 'portfolio:dashboard' %}" class="btn btn-outline-secondary me-2">Cancel</a>
                 <button type="submit" form="allocation-form" id="save-button-top" class="btn btn-primary">Save Targets</button>
            </div>
        </div>

        <form method="post" id="allocation-form">
            {% csrf_token %}
            <div class="card shadow-sm">
                <div class="card-body p-0">
                    <div class="table-responsive">
                       {% include "portfolio/includes/target_allocation_table.html" with rows=allocation_rows_percent mode="percent" table_id="allocations-table" %}
                    </div>
                </div>
            </div>

            <div class="mt-4 mb-3">
                <h3 class="h4">Target Values ($)</h3>
                <p class="text-muted small">Estimated target dollar values based on current portfolio size.</p>
            </div>
            
            <div class="card shadow-sm mb-4">
                <div class="card-body p-0">
                    <div class="table-responsive">
                         <!-- DOLLAR TABLE -->
                        {% include "portfolio/includes/target_allocation_table.html" with rows=allocation_rows_money mode="dollar" table_id="allocations-table-money" %}
                    </div>
                </div>
            </div>

            <div class="mt-3 text-end">
                <button type="submit" id="save-button-bottom" class="btn btn-primary">Save Targets</button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const expandBtns = document.querySelectorAll('.expand-btn');

    // Initial Toggle State (Sync both tables)
    expandBtns.forEach(btn => {
        btn.addEventListener('click', () => {
             const atId = btn.dataset.atId;
             const cols = document.querySelectorAll(`.col-acc-${atId}`);
             let isHidden = true;
             cols.forEach(col => {
                 if (col.classList.contains('d-none')) {
                     col.classList.remove('d-none');
                     isHidden = false;
                 } else {
                     col.classList.add('d-none');
                     isHidden = true;
                 }
             });
             btn.textContent = isHidden ? '[+]' : '[-]';
        });
    });

    const percentTable = document.querySelector('#allocations-table');
    if (!percentTable) {
        return;
    }

    const atValues = JSON.parse(document.getElementById('at-values-json')?.textContent || '{}');
    const accountTotals = JSON.parse(document.getElementById('account-totals-json')?.textContent || '{}');
    const portfolioTotalValue = JSON.parse(document.getElementById('portfolio-total-value-json')?.textContent || '0');

    function formatPercent(val) {
        const n = Number(val);
        if (!Number.isFinite(n)) {
            return '0.0%';
        }
        return `${n.toFixed(1)}%`;
    }

    function parsePercentText(text) {
        const raw = String(text ?? '').trim();
        if (!raw) return 0;
        // Handles strings like "100.0%" or "100.0%)" or "$0" gracefully.
        const m = raw.match(/-?\d+(?:\.\d+)?/);
        if (!m) return 0;
        const n = Number(m[0]);
        return Number.isFinite(n) ? n : 0;
    }

    function getInputNumber(input) {
        if (!input) return 0;
        const raw = String(input.value ?? '').trim();
        if (!raw) return 0;
        const n = Number(raw);
        return Number.isFinite(n) ? n : 0;
    }

    function recomputePortfolioTargets() {
        if (!portfolioTotalValue || portfolioTotalValue <= 0) {
            return;
        }

        // Map of category_code -> {sum, rowCount}
        const categoryTotals = new Map();
        const categoryCurrents = new Map();
        // Cash is computed as residual across non-cash rows
        let nonCashPortfolioTargetSum = 0;

        // Each row-total cell exists on non-subtotal, non-group-total, non-grand-total rows
        const rowTotalCells = percentTable.querySelectorAll('td[id^="row-total-"]');
        rowTotalCells.forEach(cell => {
            const row = cell.closest('tr');
            if (!row) return;

            // Asset class id is encoded on default inputs; use any available input in the row
            // and sum across account types: weighted target = target_pct * (at_value / portfolio_total)
            let weightedTargetSum = 0;

            // First, apply account overrides (weighted by account totals)
            const overriddenValueByAtId = {};
            const overrideInputs = row.querySelectorAll('input.override-input[data-acc-id][data-at-id]');
            overrideInputs.forEach(inp => {
                const accId = Number(inp.getAttribute('data-acc-id'));
                const atId = Number(inp.getAttribute('data-at-id'));
                const accValue = Number(accountTotals[String(accId)] ?? 0);
                const pct = getInputNumber(inp);
                const rawOverride = String(inp.value ?? '').trim();
                const isActiveOverride = rawOverride !== '' && !['0', '0.0', '0.00'].includes(rawOverride);
                if (!isActiveOverride) {
                    return;
                }
                if (accValue > 0 && portfolioTotalValue > 0) {
                    weightedTargetSum += pct * (accValue / portfolioTotalValue);
                    overriddenValueByAtId[String(atId)] = (Number(overriddenValueByAtId[String(atId)] ?? 0) + accValue);
                }
            });

            const defaultInputs = row.querySelectorAll('input.default-input[data-at-id][data-ac-id]');
            defaultInputs.forEach(inp => {
                const atId = Number(inp.getAttribute('data-at-id'));
                const atValueTotal = Number(atValues[String(atId)] ?? 0);
                const overriddenValue = Number(overriddenValueByAtId[String(atId)] ?? 0);
                const atValue = Math.max(0, atValueTotal - overriddenValue);
                const pct = getInputNumber(inp);
                if (atValue > 0 && portfolioTotalValue > 0) {
                    weightedTargetSum += pct * (atValue / portfolioTotalValue);
                }
            });

            cell.textContent = formatPercent(weightedTargetSum);

            const rowVarCell = percentTable.querySelector(`#row-var-${cell.id.replace('row-total-', '')}`);
            const portfolioCurrentCell = row.querySelector('td.table-active');
            const currentPct = parsePercentText(portfolioCurrentCell?.textContent);
            const varPct = currentPct - weightedTargetSum;
            if (rowVarCell) {
                rowVarCell.textContent = formatPercent(varPct);
            }

            const catCode = cell.getAttribute('data-category-code') || '';
            if (catCode) {
                const current = categoryTotals.get(catCode) || { sum: 0, count: 0 };
                current.sum += weightedTargetSum;
                current.count += 1;
                categoryTotals.set(catCode, current);

                const currAgg = categoryCurrents.get(catCode) || { sum: 0, count: 0 };
                currAgg.sum += currentPct;
                currAgg.count += 1;
                categoryCurrents.set(catCode, currAgg);
            }

            // Cash residual uses all non-cash rows; cash row itself is handled separately.
            if (cell.id !== 'cash-total') {
                nonCashPortfolioTargetSum += weightedTargetSum;
            }
        });

        // Update category subtotal target cells
        categoryTotals.forEach((val, catCode) => {
            const subtotal = percentTable.querySelector(`#sub-total-target-${catCode}`);
            if (subtotal) {
                subtotal.textContent = formatPercent(val.sum);
            }

            const subVar = percentTable.querySelector(`#sub-total-var-${catCode}`);
            if (subVar) {
                const curr = categoryCurrents.get(catCode) || { sum: 0 };
                subVar.textContent = formatPercent(Number(curr.sum ?? 0) - Number(val.sum ?? 0));
            }
        });

        // Update cash residual
        const cashCell = percentTable.querySelector('#cash-total');
        if (cashCell) {
            const cashPct = Math.max(0, 100 - nonCashPortfolioTargetSum);
            cashCell.textContent = formatPercent(cashPct);
        }

        const cashVarCell = percentTable.querySelector('#cash-var');
        if (cashCell && cashVarCell) {
            const cashRow = cashCell.closest('tr');
            const portfolioCurrentCell = cashRow?.querySelector('td.table-active');
            const currentPct = parsePercentText(portfolioCurrentCell?.textContent);
            const targetPct = parsePercentText(cashCell.textContent);
            cashVarCell.textContent = formatPercent(currentPct - targetPct);
        }
    }

    percentTable.addEventListener('input', (e) => {
        const target = e.target;
        if (!(target instanceof HTMLInputElement)) {
            return;
        }
        if (!target.classList.contains('default-input') && !target.classList.contains('override-input')) {
            return;
        }
        recomputePortfolioTargets();
    });

    recomputePortfolioTargets();
});
</script>

{{ at_values|json_script:"at-values-json" }}
{{ account_totals|json_script:"account-totals-json" }}
{{ portfolio_total_value|json_script:"portfolio-total-value-json" }}
{% endblock %}
