{% extends "portfolio/base.html" %}
{% load portfolio_extras %}

{% block title %}Target Allocations | CB3 Portfolio{% endblock %}

{% block content %}
<div class="row">
    <!-- Sidebar Column -->
    <div class="col-md-2 d-none d-md-block px-0">
        {% include "portfolio/sidebar.html" %}
    </div>

    <div class="col-md-10">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h2 mb-0">Target Allocations</h1>
                <p class="text-muted mt-2">
                    Set default target allocations for each account type. 
                    Expand columns to override for specific accounts.
                    <br>
                    <small>Aggregate targets are calculated bottom-up based on account values.</small>
                </p>
            </div>
            <div>
                 <a href="{% url 'portfolio:dashboard' %}" class="btn btn-outline-secondary me-2">Cancel</a>
                 <button type="submit" form="allocation-form" id="save-button-top" class="btn btn-primary">Save Targets</button>
            </div>
        </div>

        <form method="post" id="allocation-form">
            {% csrf_token %}
            <div class="card shadow-sm">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-bordered table-striped table-hover mb-0 align-middle" id="allocations-table">
                            <thead class="table-light">
                                <tr>
                                    <th scope="col" class="ps-4" rowspan="2" style="min-width: 200px;">Asset Class</th>
                                    {% for at in account_types %}
                                        <!-- Account Type Header -->
                                        <th scope="col" class="text-center border-bottom-0 position-relative" colspan="4">
                                            {{ at.label }}
                                            {% if at.active_accounts %}
                                            <button type="button" class="btn btn-sm btn-link p-0 ms-2 text-decoration-none expand-btn" 
                                                    data-at-id="{{ at.id }}" title="Show/Hide Individual Accounts">
                                                [+]
                                            </button>
                                            {% endif %}
                                        </th>
                                        <!-- Individual Accounts Headers -->
                                        {% for acc in at.active_accounts %}
                                            <th scope="col" class="text-center border-bottom-0 table-warning d-none col-acc-{{ at.id }}" colspan="3">
                                                <small>{{ acc.name }}</small>
                                            </th>
                                        {% endfor %}
                                    {% endfor %}
                                    <th scope="col" class="text-center table-active border-bottom-0" colspan="3">Total Portfolio (%)</th>
                                </tr>
                                <tr>
                                    {% for at in account_types %}
                                        <!-- Account Type Sub-headers -->
                                        <th scope="col" class="text-center small border-top-0 text-muted" style="min-width: 50px;">Current</th>
                                        <th scope="col" class="text-center small border-top-0 text-muted" style="min-width: 90px;">Target</th>
                                        <th scope="col" class="text-center small border-top-0 text-muted" style="min-width: 60px;">Wt. Target</th>
                                        <th scope="col" class="text-center small border-top-0 text-muted" style="min-width: 50px;">Variance</th>
                                        
                                        <!-- Individual Accounts Sub-headers -->
                                        {% for acc in at.active_accounts %}
                                            <th scope="col" class="text-center small border-top-0 text-muted table-warning d-none col-acc-{{ at.id }}" style="min-width: 50px;">Curr</th>
                                            <th scope="col" class="text-center small border-top-0 text-muted table-warning d-none col-acc-{{ at.id }}" style="min-width: 80px;">Override</th>
                                            <th scope="col" class="text-center small border-top-0 text-muted table-warning d-none col-acc-{{ at.id }}" style="min-width: 50px;">Eff</th>
                                        {% endfor %}
                                    {% endfor %}
                                    
                                    <th scope="col" class="text-center small table-active border-top-0 text-muted">Curr</th>
                                    <th scope="col" class="text-center small table-active border-top-0 text-muted">Target</th>
                                    <th scope="col" class="text-center small table-active border-top-0 text-muted">Var</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for group, categories in hierarchical_data %}
                                    <!-- Groups -->
                                    {% for cat_info, assets in categories %}
                                         <!-- Assets -->
                                         {% for ac in assets %}
                                            <tr data-ac-id="{{ ac.id }}">
                                                <td class="ps-4">{{ ac.name }}</td>
                                                {% for at in account_types %}
                                                    <!-- 1. Account Type Columns -->
                                                    <!-- Current -->
                                                    <td class="text-end pe-1 text-muted small" 
                                                        data-at-current="{{ at.allocation_map|get_item:ac.id|default:0 }}">
                                                        {{ at.allocation_map|get_item:ac.id|default:0|accounting_percent:1 }}
                                                    </td>

                                                    <!-- Default Input -->
                                                    <td class="p-1">
                                                        <div class="input-group input-group-sm">
                                                            <input type="number" 
                                                                   name="target_{{ at.id }}_{{ ac.id }}" 
                                                                   step="0.01" 
                                                                   min="0" 
                                                                   max="100" 
                                                                   class="form-control form-control-sm text-end default-input px-1"
                                                                   data-at-id="{{ at.id }}"
                                                                   data-ac-id="{{ ac.id }}"
                                                                   value="{{ at.target_map|get_item:ac.id|default:'' }}"
                                                                   placeholder="--">
                                                        </div>
                                                    </td>
                                                    
                                                    <!-- Aggregated % -->
                                                    <td class="text-end pe-1 small fw-bold text-muted d-none d-md-table-cell agg-cell">
                                                        <span id="agg-{{ at.id }}-{{ ac.id }}">--</span>
                                                    </td>

                                                    <!-- Variance -->
                                                    <td class="text-end pe-1 small fw-bold">
                                                        <span id="var-{{ at.id }}-{{ ac.id }}">--</span>
                                                    </td>
                                                    
                                                    <!-- Individual Accounts -->
                                                    {% for acc in at.active_accounts %}
                                                        <!-- Current -->
                                                        <td class="text-end pe-1 text-muted small table-warning d-none col-acc-{{ at.id }}">
                                                             {{ acc.allocation_map|get_item:ac.id|default:0|accounting_percent:1 }}
                                                        </td>
                                                        <!-- Override Input -->
                                                        <td class="p-1 table-warning d-none col-acc-{{ at.id }}">
                                                            <input type="number"
                                                                   name="target_account_{{ acc.id }}_{{ ac.id }}"
                                                                   step="0.01"
                                                                   min="0"
                                                                   max="100"
                                                                   class="form-control form-control-sm text-end override-input px-1"
                                                                   data-acc-id="{{ acc.id }}"
                                                                   data-at-id="{{ at.id }}"
                                                                   data-ac-id="{{ ac.id }}"
                                                                   value="{{ acc.target_map|get_item:ac.id|default:'' }}"
                                                                   placeholder="--">
                                                        </td>
                                                        <!-- Effective % -->
                                                        <td class="text-end pe-2 small table-warning d-none col-acc-{{ at.id }}">
                                                            <span id="eff-{{ acc.id }}-{{ ac.id }}" class="text-muted">--</span>
                                                        </td>
                                                    {% endfor %}
                                                {% endfor %}
                                                
                                                <!-- PORTFOLIO TOTALS -->
                                                <td class="text-end pe-2 table-active text-muted">
                                                    <!-- Calc explicit pct of total -->
                                                    {{ ac.current_total_value|percentage_of:portfolio_total_value|accounting_percent:1 }}
                                                </td>
                                                <td class="text-end pe-2 table-active">
                                                    <span id="row-total-{{ ac.id }}">0.00%</span>
                                                </td>
                                                <td class="text-end pe-2 table-active fw-bold">
                                                    <span id="row-var-{{ ac.id }}">0.00%</span>
                                                </td>
                                            </tr>
                                        {% endfor %}

                                        <!-- Subtotal Row for Category -->
                                        <tr class="table-info fw-bold category-subtotal-{{ cat_info.obj.code }}">
                                            <td class="ps-4 text-dark">{{ cat_info.obj.label }} Total</td>
                                            {% for at in account_types %}
                                                <!-- Account Type Subtotals -->
                                                <td class="text-end pe-1 small text-dark">
                                                    {{ cat_info.allocation_map|get_item:at.id|default:0|accounting_percent:1 }}
                                                </td>
                                                <td class="text-end pe-1 small text-dark">
                                                     <!-- Default Target Sum (JS will update) -->
                                                     <span id="sub-def-{{ at.id }}-{{ cat_info.obj.code }}">--</span>
                                                </td>
                                                <td class="text-end pe-1 small text-dark d-none d-md-table-cell">
                                                     <!-- Aggregated Target Sum (JS will update) -->
                                                     <span id="sub-agg-{{ at.id }}-{{ cat_info.obj.code }}">--</span>
                                                </td>
                                                <td class="text-end pe-1 small text-dark">
                                                     <!-- Variance Sum (JS will update) -->
                                                     <span id="sub-var-{{ at.id }}-{{ cat_info.obj.code }}">--</span>
                                                </td>
                                                
                                                <!-- Individual Accounts Subtotals -->
                                                {% for acc in at.active_accounts %}
                                                    <td class="text-end pe-1 small table-warning d-none col-acc-{{ at.id }} text-dark">
                                                        {{ cat_info.account_allocation_map|get_item:acc.id|default:0|accounting_percent:1 }}
                                                    </td>
                                                    <td class="text-end pe-1 small table-warning d-none col-acc-{{ at.id }} text-dark">
                                                         <!-- Override Target Sum (JS) -->
                                                         <span id="sub-over-{{ acc.id }}-{{ cat_info.obj.code }}">--</span>
                                                    </td>
                                                    <td class="text-end pe-2 small table-warning d-none col-acc-{{ at.id }} text-dark">
                                                         <!-- Effective Target Sum (JS) -->
                                                         <span id="sub-eff-{{ acc.id }}-{{ cat_info.obj.code }}">--</span>
                                                    </td>
                                                {% endfor %}
                                            {% endfor %}
                                            
                                            <!-- Portfolio Totals Subtotal -->
                                            <td class="text-end pe-2 table-active text-dark">
                                                {{ cat_info.total_value|percentage_of:portfolio_total_value|accounting_percent:1 }}
                                            </td>
                                            <td class="text-end pe-2 table-active text-dark">
                                                <span id="sub-total-target-{{ cat_info.obj.code }}">--</span>
                                            </td>
                                            <td class="text-end pe-2 table-active text-dark">
                                                <span id="sub-total-var-{{ cat_info.obj.code }}">--</span>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                {% endfor %}
                                
                                <!-- Implicit Cash Row -->
                                <tr class="table-warning fw-bold border-top-2" data-ac-id="cash">
                                    <td class="ps-4">Cash (Calculated)</td>
                                    {% for at in account_types %}
                                        <!-- Default Residual -->
                                        <td class="text-end pe-2 text-muted small"
                                            data-at-current="{{ at.allocation_map|get_item:cash_asset_class_id|default:0 }}">
                                            {{ at.allocation_map|get_item:cash_asset_class_id|default:0|accounting_percent:1 }}
                                        </td>
                                        <td class="text-end pe-2">
                                            <span id="cash-default-{{ at.id }}">100%</span>
                                        </td>
                                        <!-- Aggregated -->
                                        <td class="text-end pe-2">
                                            <span id="cash-agg-{{ at.id }}">0.0%</span>
                                        </td>
                                        <td class="text-end pe-2">
                                            <span id="cash-var-{{ at.id }}">0.0%</span>
                                        </td>
                                        
                                        {% for acc in at.active_accounts %}
                                            <!-- CASH: Current (Calculated from Holdings) -->
                                            <td class="text-end pe-2 d-none col-acc-{{ at.id }} text-muted small table-warning">
                                                 {{ acc.allocation_map|get_item:cash_asset_class_id|default:0|accounting_percent:1 }}
                                            </td>
                                            
                                            <!-- CASH: Override Input -->
                                            <td class="p-1 table-warning d-none col-acc-{{ at.id }}">
                                                 <input type="number"
                                                       name="target_account_{{ acc.id }}_{{ cash_asset_class_id }}"
                                                       step="0.01"
                                                       min="0"
                                                       max="100"
                                                       class="form-control form-control-sm text-end override-input px-1"
                                                       data-acc-id="{{ acc.id }}"
                                                       data-at-id="{{ at.id }}"
                                                       data-ac-id="cash"
                                                       value="{{ acc.target_map|get_item:cash_asset_class_id|default:'' }}"
                                                       placeholder="--">
                                            </td>

                                            <!-- CASH: Effective (Calculated or Override) -->
                                            <td class="text-end pe-2 d-none col-acc-{{ at.id }} table-warning">
                                                <span id="cash-eff-{{ acc.id }}">100%</span>
                                            </td>
                                        {% endfor %}
                                    {% endfor %}
                                    
                                    <td class="text-end pe-2 table-active">--</td>
                                    <td class="text-end pe-2 table-active">
                                        <span id="cash-total">0.00%</span>
                                    </td>
                                    <td class="text-end pe-2 table-active">
                                         <span id="cash-var">0.00%</span>
                                    </td>
                                </tr>

                                <!-- Total Row -->
                                <tr class="table-light border-top fw-bold">
                                    <td class="ps-4">Total</td>
                                    {% for at in account_types %}
                                        <td class="text-end pe-2">100%</td>
                                        <td class="text-end pe-2">
                                            <span id="total-default-{{ at.id }}" class="total-display">0.00%</span>
                                        </td>
                                        <td class="text-end pe-2">
                                            <span id="total-agg-{{ at.id }}">0.00%</span>
                                        </td>
                                        <td class="text-end pe-2">
                                            <span id="total-var-{{ at.id }}">0.00%</span>
                                        </td>
                                        {% for acc in at.active_accounts %}
                                            <td class="d-none col-acc-{{ at.id }}"></td>
                                            <td class="text-end pe-2 d-none col-acc-{{ at.id }}">
                                                 <span id="total-eff-{{ acc.id }}">100%</span>
                                            </td>
                                            <td class="d-none col-acc-{{ at.id }}"></td>
                                        {% endfor %}
                                    {% endfor %}
                                    
                                    <td class="text-end pe-2 table-active">100.0%</td>
                                    <td class="text-end pe-2 table-active">100.0%</td>
                                    <td class="text-end pe-2 table-active">0.0%</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="mt-3 text-end">
                <button type="submit" id="save-button-bottom" class="btn btn-primary">Save Targets</button>
            </div>
        </form>
    </div>
</div>

<!-- Data for JS -->
<script id="account-data" type="application/json">
{
    "account_values": {
        {% for at in account_types %}
            {% for acc in at.active_accounts %}
                "{{ acc.id }}": {{ acc.current_total_value|default:0 }},
            {% endfor %}
        {% endfor %}
        "null": 0 
    },
    "portfolio_total": {{ portfolio_total_value|default:0 }}
}
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const defaultInputs = document.querySelectorAll('.default-input');
    const overrideInputs = document.querySelectorAll('.override-input');
    const allInputs = [...defaultInputs, ...overrideInputs];
    const saveButtons = [document.getElementById('save-button-top'), document.getElementById('save-button-bottom')];
    const expandBtns = document.querySelectorAll('.expand-btn');
    
    // Parse Data
    const dataObj = JSON.parse(document.getElementById('account-data').textContent.replace(/,\s*}/, '}')); // remove trailing comma hack if needed
    const accountValues = dataObj.account_values;
    const portfolioTotal = parseFloat(dataObj.portfolio_total);

    // Initial Toggle State
    expandBtns.forEach(btn => {
        btn.addEventListener('click', () => {
             const atId = btn.dataset.atId;
             const cols = document.querySelectorAll(`.col-acc-${atId}`);
             let isHidden = true;
             cols.forEach(col => {
                 if (col.classList.contains('d-none')) {
                     col.classList.remove('d-none');
                     isHidden = false;
                 } else {
                     col.classList.add('d-none');
                     isHidden = true;
                 }
             });
             btn.textContent = isHidden ? '[+]' : '[-]';
        });
    });

    function formatPct(val) {
        return val.toFixed(1) + '%';
    }
    
    // Core Calculation Logic
    function updateCalculations() {
        let valid = true;
        
        // 1. Gather Defaults: {atId: {acId: val}}
        const defaults = {};
        const defaultTotals = {}; // atId -> total
        
        defaultInputs.forEach(inp => {
            const atId = inp.dataset.atId;
            const acId = inp.dataset.acId;
            const val = parseFloat(inp.value) || 0;
            
            if (!defaults[atId]) defaults[atId] = {};
            defaults[atId][acId] = val;
            
            if (!defaultTotals[atId]) defaultTotals[atId] = 0;
            defaultTotals[atId] += val;
        });
        
        // 2. Gather Overrides: {accId: {acId: val}}
        const overrides = {};
        overrideInputs.forEach(inp => {
            const accId = inp.dataset.accId;
            const acId = inp.dataset.acId;
            const valStr = inp.value.trim();
            
            if (valStr !== '') {
                 if (!overrides[accId]) overrides[accId] = {};
                 overrides[accId][acId] = parseFloat(valStr);
            }
        });
        
        // 3. Compute Effective Targets & Aggregate
        // We need list of all acIds (from rows)
        const assetRows = document.querySelectorAll('tr[data-ac-id]');
        const aggTargetDollars = {}; // acId -> dollars
        const atTargetDollars = {}; // atId -> {acId: dollars}
        const atTotalDollars = {}; // atId -> total target dollars across all assets (should match sum of accounts)
        
        let totalPortfolioTarget = 0;
        
        const accountEffectiveCash = {}; // accId -> val
        const atEffectiveCashDollars = {}; // atId -> dollars
        
        // Initialize aggregation buckets
        assetRows.forEach(row => {
             const acId = row.dataset.acId;
             if(acId !== 'cash') {
                 aggTargetDollars[acId] = 0;
             }
        });
        
        const accountIds = new Set();
        overrideInputs.forEach(inp => accountIds.add(inp.dataset.accId));
        const accountAtMap = {};
        overrideInputs.forEach(inp => accountAtMap[inp.dataset.accId] = inp.dataset.atId);
        
        // Compute Effective for each Account
        for (const accId of accountIds) {
            const atId = accountAtMap[accId];
            const accValue = accountValues[accId] || 0;
            const accDefaults = defaults[atId] || {};
            const accOverrides = overrides[accId] || {};
            
            // FULL OVERRIDE LOGIC: If ANY override exists for an account, ignore ALL defaults.
            // This includes explicit Cash overrides.
            const hasOverrides = Object.keys(accOverrides).length > 0;
            
            let accTotalEffectiveNonCash = 0;
            
            // Process Standard Asset Classes
            assetRows.forEach(row => {
                const acId = row.dataset.acId;
                if(acId === 'cash') return;
                
                let effective = 0;
                if (hasOverrides) {
                    // Under Full Override, if not specified, it's 0.
                    effective = accOverrides[acId] || 0;
                } else {
                    effective = accDefaults[acId] || 0;
                }
                
                accTotalEffectiveNonCash += effective;
                
                // Update UI
                const effSpan = document.getElementById(`eff-${accId}-${acId}`);
                if(effSpan) { 
                    effSpan.textContent = formatPct(effective); 
                    if(hasOverrides && accOverrides.hasOwnProperty(acId)) {
                        // Explicit override
                        effSpan.classList.add('fw-bold');
                    } else if (hasOverrides) {
                         // Implied 0 under full override
                         effSpan.classList.remove('fw-bold'); // Or maybe muted?
                    } else {
                        // Default
                        effSpan.classList.remove('fw-bold');
                    }
                }
                
                // Aggregate Dollars
                const dollars = accValue * (effective / 100);
                
                if (!atTargetDollars[atId]) atTargetDollars[atId] = {};
                if (!atTargetDollars[atId][acId]) atTargetDollars[atId][acId] = 0;
                atTargetDollars[atId][acId] += dollars;
                
                if (!aggTargetDollars[acId]) aggTargetDollars[acId] = 0;
                aggTargetDollars[acId] += dollars;
            });
            
            // Process Cash
            let cashEff = 0;
            if (hasOverrides) {
                 if (accOverrides['cash'] !== undefined) {
                      // Explicit Cash Override
                      cashEff = accOverrides['cash'];
                 } else {
                      // Implicit Residual Cash under Full Override
                      // If user overrode stocks to 60%, and didn't specify cash, cash is 40%.
                      // If user overrode stocks to 0%, cash is 100%.
                      cashEff = Math.max(0, 100 - accTotalEffectiveNonCash);
                 }
            } else {
                 // No Overrides - use Default Residual Logic logic
                 // We need calculate default totals for this AT to know default cash
                 const defTotal = defaultTotals[atId] || 0;
                 cashEff = Math.max(0, 100 - defTotal);
            }
            
            const cashSpan = document.getElementById(`cash-eff-${accId}`);
            if(cashSpan) {
                cashSpan.textContent = formatPct(cashEff);
                if (hasOverrides && accOverrides['cash'] !== undefined) {
                     cashSpan.classList.add('fw-bold', 'text-primary'); 
                } else {
                     cashSpan.classList.remove('fw-bold', 'text-primary');
                }
                
                // Warning if total != 100?
                const totalAlloc = accTotalEffectiveNonCash + cashEff;
                if (Math.abs(totalAlloc - 100) > 0.1) {
                     cashSpan.classList.add('text-danger');
                } else {
                     cashSpan.classList.remove('text-danger');
                }
            }
            
            const cashDollars = accValue * (cashEff/100);
            if (!atEffectiveCashDollars[atId]) atEffectiveCashDollars[atId] = 0;
            atEffectiveCashDollars[atId] += cashDollars;
            
            // Total Row for Account
            const totSpan = document.getElementById(`total-eff-${accId}`);
            if(totSpan) totSpan.textContent = formatPct(accTotalEffectiveNonCash + cashEff);
        }
        
        // 4. Update Aggregates in UI
        
        // Account Type Defaults
        for (const [atId, total] of Object.entries(defaultTotals)) {
             const cashDef = Math.max(0, 100 - total);
             const cashEl = document.getElementById(`cash-default-${atId}`);
             if(cashEl) cashEl.textContent = formatPct(cashDef);
             
             const totEl = document.getElementById(`total-default-${atId}`);
             if(totEl) totEl.textContent = formatPct(total + cashDef);
             
             // Check validity
             if (total > 100.01) valid = false;
        }
        
        // Account Type Aggregates (Weighted Average)
        // We need AT total value to normalize
        // But we don't have it explicitly in JS map? 
        // We can sum accountValues for the accounts belonging to AT.
        
        const atTotalValues = {};
        for(const [accId, atId] of Object.entries(accountAtMap)) {
            if(!atTotalValues[atId]) atTotalValues[atId] = 0;
            atTotalValues[atId] += (accountValues[accId] || 0);
        }
        
        // Update AT Aggregate Cells
        assetRows.forEach(row => {
            const acId = row.dataset.acId;
             if(acId === 'cash') return;
             
             for (const [atId, dollarsMap] of Object.entries(atTargetDollars)) {
                  const dollars = dollarsMap[acId] || 0;
                  const totalVal = atTotalValues[atId] || 0;
                  const pct = totalVal > 0 ? (dollars / totalVal * 100) : 0;
                  
                  const el = document.getElementById(`agg-${atId}-${acId}`);
                  if(el) el.textContent = formatPct(pct);

                  // Update Variance (Current - Wt. Target)
                  // Get Current Pct from DOM (data-at-current on 'td')
                  // We need to access the TD element that has `data-at-current`. 
                  // It's the first cell in the loop for this AT.
                  // Since we are inside assetRows loop, we can find it.
                  // The row structure is: Name | (Curr, Target, Agg, Var + AccCols) x N | ...
                  // This is getting hard to select by index. 
                  // Improved: Add ID to the Current TD in template? Or Use `data-at-current` selector scoped to row?
                  
                  // Let's assume we can select by attribute inside the row.
                  // But the attribute is on the TD, and there are multiple ATs.
                  // We can select: `row.querySelector(\`td[data-at-current]\`)` -> this gives the FIRST one.
                  // We need the one specific to AT.
                  
                  // Let's look at template again:
                  // <td class="..." data-at-current="...">...</td>
                  // It doesn't have ID or specific class for AT.
                  // I should add `data-at-id` to that TD in template to make this easy.
                  // Wait, I can't easily change template structure in this tool call without replacing the WHOLE loop.
                  // BUT, I can rely on position? No, accounts expand/contract.
                  
                  // Alternative: The `data-at-current` value was passed from backend. 
                  // I can also calculate it here if I have `at_ac_values`?
                  // I don't have `at_ac_values` in JS.
                  
                  // Let's traverse: The `agg-${atId}-${acId}` span is in a TD.
                  // The "Current" TD is 2 cells before it? 
                  // Layout: Curr | Target | Wt. Target | Variance
                  // Agg is inside Wt. Target.
                  // So properties: 
                  // Curr (index i)
                  // Target (index i+1)
                  // Agg (index i+2)
                  // Variance (index i+3)
                  
                  // So if I have the Agg Element, I can go parentElement -> previousElementSibling -> previousElementSibling.
                  const aggCell = el ? el.parentElement : null;
                  if (aggCell) {
                      const targetCell = aggCell.previousElementSibling;
                      const currCell = targetCell ? targetCell.previousElementSibling : null;
                      
                      if (currCell && currCell.dataset.atCurrent) {
                           const currentVal = parseFloat(currCell.dataset.atCurrent.replace(',','')) || 0; // Handle Django localization if any
                           const variance = currentVal - pct;
                           
                           const varEl = document.getElementById(`var-${atId}-${acId}`);
                           if (varEl) {
                               varEl.textContent = formatPct(variance);
                               // Style
                               varEl.classList.remove('text-success', 'text-danger', 'text-muted');
                               if (variance > 0.05) varEl.classList.add('text-success');
                               else if (variance < -0.05) varEl.classList.add('text-danger');
                               else varEl.classList.add('text-muted');
                           }
                      }
                  }
             }
             
             // Row Total (Portfolio)
             const totalDollars = aggTargetDollars[acId] || 0;
             const portPct = portfolioTotal > 0 ? (totalDollars / portfolioTotal * 100) : 0;
             document.getElementById(`row-total-${acId}`).textContent = formatPct(portPct);
             
             // Update Variance
             // We need Current % or Dollars from DOM?
             // Since we have `ac.current_pct` in template rendered as text, we can parse it?
             // Better: Use `data-current` attributes? Note I didn't add them yet to the replacing content.
             // Wait, I did replace the whole block.
             // I missed adding `data-current` to the row total cell in my template above.
             // But I can parse the text content.
             const currentText = row.children[row.children.length - 3].innerText.replace('%',''); // -3 is Curr col
             const currentPct = parseFloat(currentText) || 0;
             const variance = currentPct - portPct;
             const varEl = document.getElementById(`row-var-${acId}`);
             varEl.textContent = formatPct(variance);
             varEl.className = 'text-end pe-2 table-active fw-bold ' + (variance >= 0 ? 'text-success' : 'text-danger');
             // Yes, that's easier.
        });
        
        // 5. Update Category Subtotals
        const subtotalRows = document.querySelectorAll('tr[class*="category-subtotal-"]');
        subtotalRows.forEach(row => {
             // Extract category code from class
             const classes = Array.from(row.classList);
             const subClass = classes.find(c => c.startsWith('category-subtotal-'));
             if(!subClass) return;
             const catCode = subClass.replace('category-subtotal-', '');
             
             // Find all asset rows belonging to this category.
             // Limitation: We don't have explicit linking in DOM.
             // Workaround: The asset rows strictly precede the subtotal row until the previous subtotal or header.
             // Or simpler: We can attach `data-category-code` to asset rows in the template.
             // Let's assume we added that or will add it. If not, this is hard.
             // WAIT - I missed adding data-category to asset rows in previous step.
             // Let's rely on traversing PREVIOUS SIBLINGS until we hit a non-asset row?
             // That's fragile.
             // Better: Iterate ALL asset rows, check if they are visually above? No.
             
             // Correct approach: Update template to include data-category-code on rows.
             // Since I can't do that in this same step easily without context switching, 
             // I will implement a DOM traversal fallback: walk backwards from subtotal row.
             
             let sibling = row.previousElementSibling;
             
             // Accumulators
             const subDefaults = {}; // atId -> total
             const subCurrent = {}; // atId -> total pct
             const subTargetDollars = {}; // atId -> total dollars
             const subEffective = {}; // accId -> total pct sum (approx)
             const subOverrides = {}; // accId -> total
             
             while (sibling && sibling.hasAttribute('data-ac-id')) {
                  const acId = sibling.dataset.acId;
                  
                  // 1. Sum Defaults
                  for (const [atId, val] of Object.entries(defaults)) {
                       if (val[acId]) {
                            if (!subDefaults[atId]) subDefaults[atId] = 0;
                            subDefaults[atId] += val[acId];
                       }
                  }
                  
                  // 2. Sum Current & Target Dollars (for Agg Pct)
                  for (const [atId, dollarsMap] of Object.entries(atTargetDollars)) {
                       const dollars = dollarsMap[acId] || 0;
                       if (!subTargetDollars[atId]) subTargetDollars[atId] = 0;
                       subTargetDollars[atId] += dollars;
                  }
                  
                  // 3. Sum Current (from DOM)
                  const aggSpans = sibling.querySelectorAll('span[id^="agg-"]');
                  aggSpans.forEach(span => {
                      const parts = span.id.split('-');
                      const atId = parts[1];
                      // Find Curr cell relative to this span
                      const aggCell = span.parentElement;
                      const targetCell = aggCell.previousElementSibling;
                      const currCell = targetCell ? targetCell.previousElementSibling : null;
                      
                      if (currCell && currCell.dataset.atCurrent) {
                           const val = parseFloat(currCell.dataset.atCurrent.replace(',', '')) || 0;
                           if (!subCurrent[atId]) subCurrent[atId] = 0;
                           subCurrent[atId] += val;
                      }
                  });

                  // 4. Sum Effective (Percentages)
                   for (const accId of accountIds) {
                        const effSpan = document.getElementById(`eff-${accId}-${acId}`);
                        if (effSpan) {
                             const val = parseFloat(effSpan.textContent) || 0;
                             if (!subEffective[accId]) subEffective[accId] = 0;
                             subEffective[accId] += val;
                        }
                        
                        const overInp = document.querySelector(`input[name="target_account_${accId}_${acId}"]`);
                        if (overInp && overInp.value) {
                             if (!subOverrides[accId]) subOverrides[accId] = 0;
                             subOverrides[accId] += parseFloat(overInp.value);
                        }
                   }
                   
                   sibling = sibling.previousElementSibling;
             }
             
             // Render Subtotals
             
             // Defaults
             for (const [atId, val] of Object.entries(subDefaults)) {
                  const el = document.getElementById(`sub-def-${atId}-${catCode}`);
                  if(el) el.textContent = formatPct(val);
             }
             
             // Aggregates & Variance
             for(const [atId, atVal] of Object.entries(atTotalValues)) {
                  const dollars = subTargetDollars[atId] || 0;
                  const aggPct = atVal > 0 ? (dollars / atVal * 100) : 0;
                  
                  const aggEl = document.getElementById(`sub-agg-${atId}-${catCode}`);
                  if(aggEl) aggEl.textContent = formatPct(aggPct);
                  
                  // Variance
                  const currPct = subCurrent[atId] || 0;
                  const variance = currPct - aggPct;
                  
                  const varEl = document.getElementById(`sub-var-${atId}-${catCode}`);
                  if (varEl) {
                       varEl.textContent = formatPct(variance);
                       varEl.classList.remove('text-success', 'text-danger', 'text-warning');
                       if (variance > 0.05) varEl.classList.add('text-success');
                       else if (variance < -0.05) varEl.classList.add('text-danger');
                  }
             }
             
        });
        
        // Re-do Loop with better strategy:
        // 1. Identify ACs per Category (need DOM or data).
        // 2. Sum up.
        
        // Cash Aggregates
        let portCashDollars = 0;
        for (const [atId, dollars] of Object.entries(atEffectiveCashDollars)) {
             const totalVal = atTotalValues[atId] || 0;
             const pct = totalVal > 0 ? (dollars / totalVal * 100) : 0;
             const el = document.getElementById(`cash-agg-${atId}`);
             if(el) el.textContent = formatPct(pct);
             
             // Cash Variance
             const aggCell = el ? el.parentElement : null;
             if (aggCell) {
                 const defCell = aggCell.previousElementSibling; 
                 const currCell = defCell ? defCell.previousElementSibling : null;
                 
                 if (currCell && currCell.dataset.atCurrent) {
                      const curVal = parseFloat(currCell.dataset.atCurrent) || 0;
                      const variance = curVal - pct;
                      
                      const varEl = document.getElementById(`cash-var-${atId}`);
                      if (varEl) {
                           varEl.textContent = formatPct(variance);
                           varEl.classList.remove('text-success', 'text-danger', 'text-muted');
                           if (variance > 0.05) varEl.classList.add('text-success');
                           else if (variance < -0.05) varEl.classList.add('text-danger');
                           else varEl.classList.add('text-muted');
                      }
                 }
             }
             
             // Total agg
             const totEl = document.getElementById(`total-agg-${atId}`);
             if(totEl) totEl.textContent = formatPct(100); // Should always be 100% aggregation if residuals handled
             
             portCashDollars += dollars;
        }
        
        const portCashPct = portfolioTotal > 0 ? (portCashDollars / portfolioTotal * 100) : 0;
        document.getElementById(`cash-total`).textContent = formatPct(portCashPct);
        // Variance for Cash? Not strictly in DOM?
        // Added implicit cash row in template.
        
        saveButtons.forEach(btn => btn.disabled = !valid);
    }
    
    allInputs.forEach(inp => inp.addEventListener('input', updateCalculations));
    updateCalculations();
});
</script>
{% endblock %}
